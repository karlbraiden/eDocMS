/*
** Annotator v2.0.0-dev-41928d6
** https://github.com/okfn/annotator/
**
** Copyright 2014, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2014-04-11 02:53:40Z
*/
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self);var o=n;o=o.Annotator||(o.Annotator={}),o=o.Plugin||(o.Plugin={}),o.Permissions=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"4hR4NO":[function(_dereq_,module,exports){
(function (global){
var Annotator, self, _ref;

if (typeof self !== "undefined" && self !== null) {
  self = self;
}

if (typeof global !== "undefined" && global !== null) {
  if (self == null) {
    self = global;
  }
}

if (typeof window !== "undefined" && window !== null) {
  if (self == null) {
    self = window;
  }
}

Annotator = self != null ? self.Annotator : void 0;

if (Annotator == null) {
  Annotator = (self != null ? (_ref = self.define) != null ? _ref.amd : void 0 : void 0) ? self != null ? self.require('annotator') : void 0 : void 0;
}

if (typeof Annotator !== 'function') {
  throw new Error("Could not find Annotator! In a webpage context, please ensure that the Annotator script tag is loaded before any plugins.");
}

module.exports = Annotator;


}).call(this,typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],"annotator":[function(_dereq_,module,exports){
module.exports=_dereq_('4hR4NO');
},{}],3:[function(_dereq_,module,exports){
var $, Annotator, Permissions, _t,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Annotator = _dereq_('annotator');

$ = Annotator.Util.$;

_t = Annotator.Util.TranslationString;

Permissions = (function(_super) {
  __extends(Permissions, _super);

  Permissions.prototype.options = {
    showViewPermissionsCheckbox: true,
    showEditPermissionsCheckbox: true,
    userId: function(user) {
      return user;
    },
    userString: function(user) {
      return user;
    },
    userAuthorize: function(action, annotation, user) {
      var token, tokens, _i, _len;
      if (annotation.permissions) {
        tokens = annotation.permissions[action] || [];
        if (tokens.length === 0) {
          return true;
        }
        for (_i = 0, _len = tokens.length; _i < _len; _i++) {
          token = tokens[_i];
          if (this.userId(user) === token) {
            return true;
          }
        }
        return false;
      } else if (annotation.user) {
        if (user) {
          return this.userId(user) === this.userId(annotation.user);
        } else {
          return false;
        }
      }
      return true;
    },
    user: '',
    permissions: {
      read: [],
      update: [],
      "delete": [],
      admin: []
    }
  };

  function Permissions(element, options) {
    this._setAuthFromToken = __bind(this._setAuthFromToken, this);
    this.updateViewer = __bind(this.updateViewer, this);
    this.updateAnnotationPermissions = __bind(this.updateAnnotationPermissions, this);
    this.updatePermissionsField = __bind(this.updatePermissionsField, this);
    this.addFieldsToAnnotation = __bind(this.addFieldsToAnnotation, this);
    Permissions.__super__.constructor.apply(this, arguments);
    if (this.options.user) {
      this.setUser(this.options.user);
      delete this.options.user;
    }
  }

  Permissions.prototype.pluginInit = function() {
    var createCallback, self;
    if (!Annotator.supported()) {
      return;
    }
    this.annotator.subscribe('beforeAnnotationCreated', this.addFieldsToAnnotation);
    self = this;
    createCallback = function(method, type) {
      return function(field, annotation) {
        return self[method].call(self, type, field, annotation);
      };
    };
    if (!this.user && this.annotator.plugins.Auth) {
      this.annotator.plugins.Auth.withToken(this._setAuthFromToken);
    }
    if (this.options.showViewPermissionsCheckbox === true) {
      this.annotator.editor.addField({
        type: 'checkbox',
        label: _t('Allow anyone to <strong>view</strong> this annotation'),
        load: createCallback('updatePermissionsField', 'read'),
        submit: createCallback('updateAnnotationPermissions', 'read')
      });
    }
    if (this.options.showEditPermissionsCheckbox === true) {
      this.annotator.editor.addField({
        type: 'checkbox',
        label: _t('Allow anyone to <strong>edit</strong> this annotation'),
        load: createCallback('updatePermissionsField', 'update'),
        submit: createCallback('updateAnnotationPermissions', 'update')
      });
    }
    this.annotator.viewer.addField({
      load: this.updateViewer
    });
    if (this.annotator.plugins.Filter) {
      return this.annotator.plugins.Filter.addFilter({
        label: _t('User'),
        property: 'user',
        isFiltered: (function(_this) {
          return function(input, user) {
            var keyword, _i, _len, _ref;
            user = _this.options.userString(user);
            if (!(input && user)) {
              return false;
            }
            _ref = input.split(/\s*/);
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              keyword = _ref[_i];
              if (user.indexOf(keyword) === -1) {
                return false;
              }
            }
            return true;
          };
        })(this)
      });
    }
  };

  Permissions.prototype.setUser = function(user) {
    return this.user = user;
  };

  Permissions.prototype.addFieldsToAnnotation = function(annotation) {
    if (annotation) {
      annotation.permissions = this.options.permissions;
      if (this.user) {
        return annotation.user = this.user;
      }
    }
  };

  Permissions.prototype.authorize = function(action, annotation, user) {
    if (user === void 0) {
      user = this.user;
    }
    if (this.options.userAuthorize) {
      return this.options.userAuthorize.call(this.options, action, annotation, user);
    } else {
      return true;
    }
  };

  Permissions.prototype.updatePermissionsField = function(action, field, annotation) {
    var input;
    field = $(field).show();
    input = field.find('input').removeAttr('disabled');
    if (!this.authorize('admin', annotation)) {
      field.hide();
    }
    if (this.authorize(action, annotation || {}, null)) {
      return input.attr('checked', 'checked');
    } else {
      return input.removeAttr('checked');
    }
  };

  Permissions.prototype.updateAnnotationPermissions = function(type, field, annotation) {
    var dataKey;
    if (!annotation.permissions) {
      annotation.permissions = this.options.permissions;
    }
    dataKey = type + '-permissions';
    if ($(field).find('input').is(':checked')) {
      return annotation.permissions[type] = [];
    } else {
      return annotation.permissions[type] = [this.options.userId(this.user)];
    }
  };

  Permissions.prototype.updateViewer = function(field, annotation, controls) {
    var user, username;
    field = $(field);
    username = this.options.userString(annotation.user);
    if (annotation.user && username && typeof username === 'string') {
      user = Annotator.Util.escape(this.options.userString(annotation.user));
      field.html(user).addClass('annotator-user');
    } else {
      field.remove();
    }
    if (controls) {
      if (!this.authorize('update', annotation)) {
        controls.hideEdit();
      }
      if (!this.authorize('delete', annotation)) {
        return controls.hideDelete();
      }
    }
  };

  Permissions.prototype._setAuthFromToken = function(token) {
    return this.setUser(token.userId);
  };

  return Permissions;

})(Annotator.Plugin);

Annotator.Plugin.register('Permissions', Permissions);

module.exports = Permissions;


},{}]},{},[3])

(3)
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnL2Fubm90YXRvci5wZXJtaXNzaW9ucy5qcyIsInNvdXJjZXMiOlsiLi4vbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsIm5hbWVzcGFjZS5jb2ZmZWUiLCJwbHVnaW4vcGVybWlzc2lvbnMuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTtBQ0tBOzs7U0FBTyxJQUFQOzs7QUFDQTs7V0FBUTtHQUFSO0NBREE7O0FBRUE7O1dBQVE7R0FBUjtDQUZBOzs7OztFQU1BLHNCQUFhO0NBTmI7O0FBVUE7QUFDRSxRQUFVLFVBQU0sb0JBRGxCO0NBVkE7Ozs7Ozs7Ozs7QUNMQTs7Ozs7WUFBWSxRQUFRLFdBQVIsQ0FBWjs7Q0FDQSxHQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FEbkI7O0VBRUEsR0FBSyxTQUFTLENBQUMsSUFBSSxDQUFDLGlCQUZwQjs7O0FBd0JFOztrQ0FHRTtpQ0FBNkIsSUFBN0I7SUFHQSw2QkFBNkIsSUFIN0I7SUFZQSxRQUFRLFNBQUMsSUFBRDthQUFVLEtBQVY7S0FaUjtJQXFCQSxZQUFZLFNBQUMsSUFBRDthQUFVLEtBQVY7S0FyQlo7SUFzRUEsZUFBZSxTQUFDLE1BQUQsRUFBUyxVQUFULEVBQXFCLElBQXJCO0FBRWI7VUFBRyxVQUFVLENBQUMsV0FBZDtBQUNFLGlCQUFTLFVBQVUsQ0FBQyxXQUFZLFFBQXZCLElBQWtDLEVBQTNDO0FBRUEsWUFBRyxNQUFNLENBQUMsTUFBUCxLQUFpQixDQUFwQjtBQUVFLGlCQUFPLElBQVAsQ0FGRjtTQUZBO0FBTUE7O0FBQ0UsY0FBRyxJQUFJLENBQUMsTUFBTCxDQUFZLElBQVosTUFBcUIsS0FBeEI7QUFDRSxtQkFBTyxJQUFQLENBREY7V0FERjtTQU5BO0FBV0EsZUFBTyxLQUFQLENBWkY7YUFlSyxJQUFHLFVBQVUsQ0FBQyxJQUFkO0FBQ0gsWUFBRyxJQUFIO0FBQ0UsaUJBQU8sSUFBSSxDQUFD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QXpDLENBdlVBOztNQXlVTSxDQUFDLE9BQVAsR0FBaUIsV0F6VWpCIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIjIEluIG9yZGVyIHRvIGJ1aWxkIHBvcnRhYmxlIGV4dGVuc2lvbiBidW5kbGVzIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBBTUQgYW5kXG4jIHNjcmlwdCBjb25jYXRlbmF0aW9uIHBsdWdpbnMgYXJlIGJ1aWx0IHdpdGggdGhpcyBtb2R1bGUgYXMgJ2Fubm90YXRvcicuXG5cbiMgQW5ub3RhdG9yIHdpbGwgZXhwb3J0IGl0c2VsZiBnbG9iYWxseSB3aGVuIHRoZSBidWlsdCBVTUQgbW9kdWxlcyBhcmUgdXNlZCBpblxuIyBhIGxlZ2FjeSBlbnZpcm9ubWVudCBvZiBzaW1wbGUgc2NyaXB0IGNvbmNhdGVuYXRpb24uXG5zZWxmID0gc2VsZiBpZiBzZWxmP1xuc2VsZiA/PSBnbG9iYWwgaWYgZ2xvYmFsP1xuc2VsZiA/PSB3aW5kb3cgaWYgd2luZG93P1xuQW5ub3RhdG9yID0gc2VsZj8uQW5ub3RhdG9yXG5cbiMgSW4gYSBwdXJlIEFNRCBlbnZpcm9ubWVudCwgQW5ub3RhdG9yIG1heSBub3QgYmUgZXhwb3J0ZWQgZ2xvYmFsbHkuXG5Bbm5vdGF0b3IgPz0gaWYgc2VsZj8uZGVmaW5lPy5hbWQgdGhlbiBzZWxmPy5yZXF1aXJlKCdhbm5vdGF0b3InKVxuXG4jIElmIHdlIGhhdmVuJ3Qgc3VjY2Vzc2Z1bGx5IGxvYWRlZCBBbm5vdGF0b3IgYnkgdGhpcyBwb2ludCwgdGhlcmUncyBubyBwb2ludCBpblxuIyBnb2luZyBvbiB0byBsb2FkIHRoZSBwbHVnaW4sIHNvIHRocm93IGEgZmF0YWwgZXJyb3IuXG5pZiB0eXBlb2YgQW5ub3RhdG9yIGlzbnQgJ2Z1bmN0aW9uJ1xuICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZmluZCBBbm5vdGF0b3IhIEluIGEgd2VicGFnZSBjb250ZXh0LCBwbGVhc2UgZW5zdXJlXG4gICAgICAgICAgICAgICAgICAgdGhhdCB0aGUgQW5ub3RhdG9yIHNjcmlwdCB0YWcgaXMgbG9hZGVkIGJlZm9yZSBhbnkgcGx1Z2lucy5cIilcblxuIyBOb3RlOiB3aGVuIHdvcmtpbmcgaW4gYSBDb21tb25KUyBlbnZpcm9ubWVudCBhbmQgYnVuZGxpbmcgcmVxdWlyZW1lbnRzIGludG9cbiMgYXBwbGljYXRpb25zIHRoZW4gcmVxdWlyZSBjYWxscyBzaG91bGQgcmVmZXIgdG8gbW9kdWxlcyBmcm9tIHRoZSBucG0gbGliXG4jIGRpcmVjdG9yeSBvZiBhbm5vdGF0b3IgcGFja2FnZSBhbmQgYXZvaWQgdGhpcyBhbHRvZ2V0aGVyLlxubW9kdWxlLmV4cG9ydHMgPSBBbm5vdGF0b3JcbiIsIkFubm90YXRvciA9IHJlcXVpcmUoJ2Fubm90YXRvcicpXG4kID0gQW5ub3RhdG9yLlV0aWwuJFxuX3QgPSBBbm5vdGF0b3IuVXRpbC5UcmFuc2xhdGlvblN0cmluZ1xuXG5cbiMgUHVibGljOiBQbHVnaW4gZm9yIHNldHRpbmcgcGVybWlzc2lvbnMgb24gbmV3bHkgY3JlYXRlZCBhbm5vdGF0aW9ucyBhcyB3ZWxsIGFzXG4jIG1hbmFnaW5nIHVzZXIgcGVybWlzc2lvbnMgc3VjaCBhcyB2aWV3aW5nL2VkaXRpbmcvZGVsZXRpbmcgYW5ub3Rpb25zLlxuI1xuIyBlbGVtZW50IC0gQSBET00gRWxlbWVudCB1cG9uIHdoaWNoIGV2ZW50cyBhcmUgYm91bmQuIFdoZW4gaW5pdGlhbGlzZWQgYnlcbiMgICAgICAgICAgIHRoZSBBbm5vdGF0b3IgaXQgaXMgdGhlIEFubm90YXRvciBlbGVtZW50LlxuIyBvcHRpb25zIC0gQW4gT2JqZWN0IGxpdGVyYWwgY29udGFpbmluZyBjdXN0b20gb3B0aW9ucy5cbiNcbiMgRXhhbXBsZXNcbiNcbiMgICBuZXcgQW5ub3RhdG9yLnBsdWdpbi5QZXJtaXNzaW9ucyhhbm5vdGF0b3IuZWxlbWVudCwge1xuIyAgICAgdXNlcjogJ0FsaWNlJ1xuIyAgIH0pXG4jXG4jIFJldHVybnMgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIFBlcm1pc3Npb25zIE9iamVjdC5cbmNsYXNzIFBlcm1pc3Npb25zIGV4dGVuZHMgQW5ub3RhdG9yLlBsdWdpblxuXG4gICMgY29mZmVlbGludDogZGlzYWJsZT1taXNzaW5nX2ZhdF9hcnJvd3NcblxuICAjIEEgT2JqZWN0IGxpdGVyYWwgb2YgZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2xhc3MuXG4gIG9wdGlvbnM6XG5cbiAgICAjIERpc3BsYXlzIGFuIFwiQW55b25lIGNhbiB2aWV3IHRoaXMgYW5ub3RhdGlvblwiIGNoZWNrYm94IGluIHRoZSBFZGl0b3IuXG4gICAgc2hvd1ZpZXdQZXJtaXNzaW9uc0NoZWNrYm94OiB0cnVlXG5cbiAgICAjIERpc3BsYXlzIGFuIFwiQW55b25lIGNhbiBlZGl0IHRoaXMgYW5ub3RhdGlvblwiIGNoZWNrYm94IGluIHRoZSBFZGl0b3IuXG4gICAgc2hvd0VkaXRQZXJtaXNzaW9uc0NoZWNrYm94OiB0cnVlXG5cbiAgICAjIFB1YmxpYzogVXNlZCBieSB0aGUgcGx1Z2luIHRvIGRldGVybWluZSBhIHVuaXF1ZSBpZCBmb3IgdGhlIEB1c2VyXG4gICAgIyBwcm9wZXJ0eS4gQnkgZGVmYXVsdCB0aGlzIGFjY2VwdHMgYW5kIHJldHVybnMgdGhlIHVzZXIgU3RyaW5nIGJ1dCBjYW4gYmVcbiAgICAjIG92ZXJyaWRkZW4gaW4gdGhlIEBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW50byB0aGUgY29uc3RydWN0b3IuXG4gICAgI1xuICAgICMgdXNlciAtIEEgU3RyaW5nIHVzZXJuYW1lIG9yIG51bGwgaWYgbm8gdXNlciBpcyBzZXQuXG4gICAgI1xuICAgICMgUmV0dXJucyB0aGUgU3RyaW5nIHByb3ZpZGVkIGFzIHVzZXIgb2JqZWN0LlxuICAgIHVzZXJJZDogKHVzZXIpIC0+IHVzZXJcblxuICAgICMgUHVibGljOiBVc2VkIGJ5IHRoZSBwbHVnaW4gdG8gZGV0ZXJtaW5lIGEgZGlzcGxheSBuYW1lIGZvciB0aGUgQHVzZXJcbiAgICAjIHByb3BlcnR5LiBCeSBkZWZhdWx0IHRoaXMgYWNjZXB0cyBhbmQgcmV0dXJucyB0aGUgdXNlciBTdHJpbmcgYnV0IGNhbiBiZVxuICAgICMgb3Zlci1yaWRkZW4gaW4gdGhlIEBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW50byB0aGUgY29uc3RydWN0b3IuXG4gICAgI1xuICAgICMgdXNlciAtIEEgU3RyaW5nIHVzZXJuYW1lIG9yIG51bGwgaWYgbm8gdXNlciBpcyBzZXQuXG4gICAgI1xuICAgICMgUmV0dXJucyB0aGUgU3RyaW5nIHByb3ZpZGVkIGFzIHVzZXIgb2JqZWN0XG4gICAgdXNlclN0cmluZzogKHVzZXIpIC0+IHVzZXJcblxuICAgICMgUHVibGljOiBVc2VkIGJ5IFBlcm1pc3Npb25zI2F1dGhvcml6ZSB0byBkZXRlcm1pbmUgd2hldGhlciBhIHVzZXIgY2FuXG4gICAgIyBwZXJmb3JtIGFuIGFjdGlvbiBvbiBhbiBhbm5vdGF0aW9uLiBPdmVycmlkaW5nIHRoaXMgZnVuY3Rpb24gYWxsb3dzXG4gICAgIyBhIGZhciBtb3JlIGNvbXBsZXggcGVybWlzc2lvbnMgc3lzeWVtLlxuICAgICNcbiAgICAjIEJ5IGRlZmF1bHQgdGhpcyBhdXRob3JpemVzIHRoZSBhY3Rpb24gaWYgYW55IG9mIHRocmVlIHNjZW5hcmlvcyBhcmUgdHJ1ZTpcbiAgICAjXG4gICAgIyAgICAgMSkgdGhlIGFubm90YXRpb24gaGFzIGEgJ3Blcm1pc3Npb25zJyBvYmplY3QsIGFuZCBlaXRoZXIgdGhlIGZpZWxkIGZvclxuICAgICMgICAgICAgIHRoZSBzcGVjaWZpZWQgYWN0aW9uIGlzIG1pc3NpbmcsIGVtcHR5LCBvciBjb250YWlucyB0aGUgdXNlcklkIG9mXG4gICAgIyAgICAgICAgdGhlIGN1cnJlbnQgdXNlciwgaS5lLiBAb3B0aW9ucy51c2VySWQoQHVzZXIpXG4gICAgI1xuICAgICMgICAgIDIpIHRoZSBhbm5vdGF0aW9uIGhhcyBhICd1c2VyJyBwcm9wZXJ0eSwgYW5kIEBvcHRpb25zLnVzZXJJZChAdXNlcilcbiAgICAjICAgICAgICBtYXRjaGVzICdhbm5vdGF0aW9uLnVzZXInXG4gICAgI1xuICAgICMgICAgIDMpIHRoZSBhbm5vdGF0aW9uIGhhcyBubyAncGVybWlzc2lvbnMnIG9yICd1c2VyJyBwcm9wZXJ0aWVzXG4gICAgI1xuICAgICMgYW5ub3RhdGlvbiAtIFRoZSBhbm5vdGF0aW9uIG9uIHdoaWNoIHRoZSBhY3Rpb24gaXMgYmVpbmcgcmVxdWVzdGVkLlxuICAgICMgYWN0aW9uIC0gVGhlIGFjdGlvbiBiZWluZyByZXF1ZXN0ZWQ6IGUuZy4gJ3VwZGF0ZScsICdkZWxldGUnLlxuICAgICMgdXNlciAtIFRoZSB1c2VyIG9iamVjdCAob3Igc3RyaW5nKSByZXF1ZXN0aW5nIHRoZSBhY3Rpb24uIFRoaXMgaXMgdXN1YWxseVxuICAgICMgICAgICAgIGF1dG9tYXRpY2FsbHkgcGFzc2VkIGJ5IFBlcm1pc3Npb25zI2F1dGhvcml6ZSBhcyB0aGUgY3VycmVudCB1c2VyXG4gICAgIyAgICAgICAgKEB1c2VyKVxuICAgICNcbiAgICAjICAgcGVybWlzc2lvbnMuc2V0VXNlcihudWxsKVxuICAgICMgICBwZXJtaXNzaW9ucy5hdXRob3JpemUoJ3VwZGF0ZScsIHt9KVxuICAgICMgICAjID0+IHRydWVcbiAgICAjXG4gICAgIyAgIHBlcm1pc3Npb25zLnNldFVzZXIoJ2FsaWNlJylcbiAgICAjICAgcGVybWlzc2lvbnMuYXV0aG9yaXplKCd1cGRhdGUnLCB7dXNlcjogJ2FsaWNlJ30pXG4gICAgIyAgICMgPT4gdHJ1ZVxuICAgICMgICBwZXJtaXNzaW9ucy5hdXRob3JpemUoJ3VwZGF0ZScsIHt1c2VyOiAnYm9iJ30pXG4gICAgIyAgICMgPT4gZmFsc2VcbiAgICAjXG4gICAgIyAgIHBlcm1pc3Npb25zLnNldFVzZXIoJ2FsaWNlJylcbiAgICAjICAgcGVybWlzc2lvbnMuYXV0aG9yaXplKCd1cGRhdGUnLCB7XG4gICAgIyAgICAgdXNlcjogJ2JvYicsXG4gICAgIyAgICAgcGVybWlzc2lvbnM6IFsndXBkYXRlJzogWydhbGljZScsICdib2InXV1cbiAgICAjICAgfSlcbiAgICAjICAgIyA9PiB0cnVlXG4gICAgIyAgIHBlcm1pc3Npb25zLmF1dGhvcml6ZSgnZGVzdHJveScsIHtcbiAgICAjICAgICB1c2VyOiAnYm9iJyxcbiAgICAjICAgICBwZXJtaXNzaW9uczogW1xuICAgICMgICAgICAgJ3VwZGF0ZSc6IFsnYWxpY2UnLCAnYm9iJ11cbiAgICAjICAgICAgICdkZXN0cm95JzogWydib2InXVxuICAgICMgICAgIF1cbiAgICAjICAgfSlcbiAgICAjICAgIyA9PiBmYWxzZVxuICAgICNcbiAgICAjIFJldHVybnMgYSBCb29sZWFuLCB0cnVlIGlmIHRoZSB1c2VyIGlzIGF1dGhvcmlzZWQgZm9yIHRoZSB0b2tlbiBwcm92aWRlZC5cbiAgICB1c2VyQXV0aG9yaXplOiAoYWN0aW9uLCBhbm5vdGF0aW9uLCB1c2VyKSAtPlxuICAgICAgIyBGaW5lLWdyYWluZWQgY3VzdG9tIGF1dGhvcml6YXRpb25cbiAgICAgIGlmIGFubm90YXRpb24ucGVybWlzc2lvbnNcbiAgICAgICAgdG9rZW5zID0gYW5ub3RhdGlvbi5wZXJtaXNzaW9uc1thY3Rpb25dIHx8IFtdXG5cbiAgICAgICAgaWYgdG9rZW5zLmxlbmd0aCA9PSAwXG4gICAgICAgICAgIyBFbXB0eSBvciBtaXNzaW5nIHRva2VucyBhcnJheTogYW55b25lIGNhbiBwZXJmb3JtIGFjdGlvbi5cbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuXG4gICAgICAgIGZvciB0b2tlbiBpbiB0b2tlbnNcbiAgICAgICAgICBpZiB0aGlzLnVzZXJJZCh1c2VyKSA9PSB0b2tlblxuICAgICAgICAgICAgcmV0dXJuIHRydWVcblxuICAgICAgICAjIE5vIHRva2VucyBtYXRjaGVkOiBhY3Rpb24gc2hvdWxkIG5vdCBiZSBwZXJmb3JtZWQuXG4gICAgICAgIHJldHVybiBmYWxzZVxuXG4gICAgICAjIENvYXJzZS1ncmFpbmVkIGF1dGhvcml6YXRpb25cbiAgICAgIGVsc2UgaWYgYW5ub3RhdGlvbi51c2VyXG4gICAgICAgIGlmIHVzZXJcbiAgICAgICAgICByZXR1cm4gdGhpcy51c2VySWQodXNlcikgPT0gdGhpcy51c2VySWQoYW5ub3RhdGlvbi51c2VyKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG5cbiAgICAgICMgTm8gYXV0aG9yaXphdGlvbiBpbmZvIG9uIGFubm90YXRpb246IGZyZWUtZm9yLWFsbCFcbiAgICAgIHRydWVcblxuICAgICMgRGVmYXVsdCB1c2VyIG9iamVjdC5cbiAgICB1c2VyOiAnJ1xuXG4gICAgIyBEZWZhdWx0IHBlcm1pc3Npb25zIGZvciBhbGwgYW5ub3RhdGlvbnMuIEFueW9uZSBjYW4gZG8gYW55dGhpbmdcbiAgICAjIChhc3N1bWluZyBkZWZhdWx0IHVzZXJBdXRob3JpemUgZnVuY3Rpb24pLlxuICAgIHBlcm1pc3Npb25zOlxuICAgICAgcmVhZDogW11cbiAgICAgIHVwZGF0ZTogW11cbiAgICAgIGRlbGV0ZTogW11cbiAgICAgIGFkbWluOiBbXVxuXG4gICMgY29mZmVlbGludDogZW5hYmxlPW1pc3NpbmdfZmF0X2Fycm93c1xuXG4gICMgVGhlIGNvbnN0cnVjdG9yIGNhbGxlZCB3aGVuIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBQZXJtaXNzaW9uc1xuICAjIHBsdWdpbiBpcyBjcmVhdGVkLiBTZWUgY2xhc3MgZG9jdW1lbnRhdGlvbiBmb3IgdXNhZ2UuXG4gICNcbiAgIyBlbGVtZW50IC0gQSBET00gRWxlbWVudCB1cG9uIHdoaWNoIGV2ZW50cyBhcmUgYm91bmQuLlxuICAjIG9wdGlvbnMgLSBBbiBPYmplY3QgbGl0ZXJhbCBjb250YWluaW5nIGN1c3RvbSBvcHRpb25zLlxuICAjXG4gICMgUmV0dXJucyBhbiBpbnN0YW5jZSBvZiB0aGUgUGVybWlzc2lvbnMgb2JqZWN0LlxuICBjb25zdHJ1Y3RvcjogKGVsZW1lbnQsIG9wdGlvbnMpIC0+XG4gICAgc3VwZXJcblxuICAgIGlmIEBvcHRpb25zLnVzZXJcbiAgICAgIHRoaXMuc2V0VXNlcihAb3B0aW9ucy51c2VyKVxuICAgICAgZGVsZXRlIEBvcHRpb25zLnVzZXJcblxuICAjIFB1YmxpYzogSW5pdGlhbGl6ZXMgdGhlIHBsdWdpbiBhbmQgcmVnaXN0ZXJzIGZpZWxkcyB3aXRoIHRoZVxuICAjIEFubm90YXRvci5FZGl0b3IgYW5kIEFubm90YXRvci5WaWV3ZXIuXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIHBsdWdpbkluaXQ6IC0+XG4gICAgcmV0dXJuIHVubGVzcyBBbm5vdGF0b3Iuc3VwcG9ydGVkKClcblxuICAgIEBhbm5vdGF0b3Iuc3Vic2NyaWJlKCdiZWZvcmVBbm5vdGF0aW9uQ3JlYXRlZCcsIHRoaXMuYWRkRmllbGRzVG9Bbm5vdGF0aW9uKVxuXG4gICAgc2VsZiA9IHRoaXNcbiAgICBjcmVhdGVDYWxsYmFjayA9IChtZXRob2QsIHR5cGUpIC0+XG4gICAgICAoZmllbGQsIGFubm90YXRpb24pIC0+IHNlbGZbbWV0aG9kXS5jYWxsKHNlbGYsIHR5cGUsIGZpZWxkLCBhbm5vdGF0aW9uKVxuXG4gICAgIyBTZXQgdXAgdXNlciBhbmQgZGVmYXVsdCBwZXJtaXNzaW9ucyBmcm9tIGF1dGggdG9rZW4gaWYgbm9uZSBjdXJyZW50bHlcbiAgICAjIGdpdmVuXG4gICAgaWYgIUB1c2VyIGFuZCBAYW5ub3RhdG9yLnBsdWdpbnMuQXV0aFxuICAgICAgQGFubm90YXRvci5wbHVnaW5zLkF1dGgud2l0aFRva2VuKHRoaXMuX3NldEF1dGhGcm9tVG9rZW4pXG5cbiAgICBpZiBAb3B0aW9ucy5zaG93Vmlld1Blcm1pc3Npb25zQ2hlY2tib3ggPT0gdHJ1ZVxuICAgICAgQGFubm90YXRvci5lZGl0b3IuYWRkRmllbGQoe1xuICAgICAgICB0eXBlOiAnY2hlY2tib3gnXG4gICAgICAgIGxhYmVsOiBfdCgnQWxsb3cgYW55b25lIHRvIDxzdHJvbmc+dmlldzwvc3Ryb25nPiB0aGlzIGFubm90YXRpb24nKVxuICAgICAgICBsb2FkOiBjcmVhdGVDYWxsYmFjaygndXBkYXRlUGVybWlzc2lvbnNGaWVsZCcsICdyZWFkJylcbiAgICAgICAgc3VibWl0OiBjcmVhdGVDYWxsYmFjaygndXBkYXRlQW5ub3RhdGlvblBlcm1pc3Npb25zJywgJ3JlYWQnKVxuICAgICAgfSlcblxuICAgIGlmIEBvcHRpb25zLnNob3dFZGl0UGVybWlzc2lvbnNDaGVja2JveCA9PSB0cnVlXG4gICAgICBAYW5ub3RhdG9yLmVkaXRvci5hZGRGaWVsZCh7XG4gICAgICAgIHR5cGU6ICdjaGVja2JveCdcbiAgICAgICAgbGFiZWw6IF90KCdBbGxvdyBhbnlvbmUgdG8gPHN0cm9uZz5lZGl0PC9zdHJvbmc+IHRoaXMgYW5ub3RhdGlvbicpXG4gICAgICAgIGxvYWQ6IGNyZWF0ZUNhbGxiYWNrKCd1cGRhdGVQZXJtaXNzaW9uc0ZpZWxkJywgJ3VwZGF0ZScpXG4gICAgICAgIHN1Ym1pdDogY3JlYXRlQ2FsbGJhY2soJ3VwZGF0ZUFubm90YXRpb25QZXJtaXNzaW9ucycsICd1cGRhdGUnKVxuICAgICAgfSlcblxuICAgICMgU2V0dXAgdGhlIGRpc3BsYXkgb2YgYW5ub3RhdGlvbnMgaW4gdGhlIFZpZXdlci5cbiAgICBAYW5ub3RhdG9yLnZpZXdlci5hZGRGaWVsZCh7XG4gICAgICBsb2FkOiB0aGlzLnVwZGF0ZVZpZXdlclxuICAgIH0pXG5cbiAgICAjIEFkZCBhIGZpbHRlciB0byB0aGUgRmlsdGVyIHBsdWdpbiBpZiBsb2FkZWQuXG4gICAgaWYgQGFubm90YXRvci5wbHVnaW5zLkZpbHRlclxuICAgICAgQGFubm90YXRvci5wbHVnaW5zLkZpbHRlci5hZGRGaWx0ZXIoe1xuICAgICAgICBsYWJlbDogX3QoJ1VzZXInKVxuICAgICAgICBwcm9wZXJ0eTogJ3VzZXInXG4gICAgICAgIGlzRmlsdGVyZWQ6IChpbnB1dCwgdXNlcikgPT5cbiAgICAgICAgICB1c2VyID0gQG9wdGlvbnMudXNlclN0cmluZyh1c2VyKVxuXG4gICAgICAgICAgcmV0dXJuIGZhbHNlIHVubGVzcyBpbnB1dCBhbmQgdXNlclxuICAgICAgICAgIGZvciBrZXl3b3JkIGluIChpbnB1dC5zcGxpdCAvXFxzKi8pXG4gICAgICAgICAgICByZXR1cm4gZmFsc2UgaWYgdXNlci5pbmRleE9mKGtleXdvcmQpID09IC0xXG5cbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSlcblxuICAjIFB1YmxpYzogU2V0cyB0aGUgUGVybWlzc2lvbnMjdXNlciBwcm9wZXJ0eS5cbiAgI1xuICAjIHVzZXIgLSBBIFN0cmluZyBvciBPYmplY3QgdG8gcmVwcmVzZW50IHRoZSBjdXJyZW50IHVzZXIuXG4gICNcbiAgIyBFeGFtcGxlc1xuICAjXG4gICMgICBwZXJtaXNzaW9ucy5zZXRVc2VyKCdBbGljZScpXG4gICNcbiAgIyAgIHBlcm1pc3Npb25zLnNldFVzZXIoe2lkOiAzNSwgbmFtZTogJ0FsaWNlJ30pXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIHNldFVzZXI6ICh1c2VyKSAtPlxuICAgIEB1c2VyID0gdXNlclxuXG4gICMgRXZlbnQgY2FsbGJhY2s6IEFwcGVuZHMgdGhlIEB1c2VyIGFuZCBAb3B0aW9ucy5wZXJtaXNzaW9ucyBvYmplY3RzIHRvIHRoZVxuICAjIHByb3ZpZGVkIGFubm90YXRpb24gb2JqZWN0LiBPbmx5IGFwcGVuZHMgdGhlIHVzZXIgaWYgb25lIGhhcyBiZWVuIHNldC5cbiAgI1xuICAjIGFubm90YXRpb24gLSBBbiBhbm5vdGF0aW9uIG9iamVjdC5cbiAgI1xuICAjIEV4YW1wbGVzXG4gICNcbiAgIyAgIGFubm90YXRpb24gPSB7dGV4dDogJ015IGNvbW1lbnQnfVxuICAjICAgcGVybWlzc2lvbnMuYWRkRmllbGRzVG9Bbm5vdGF0aW9uKGFubm90YXRpb24pXG4gICMgICBjb25zb2xlLmxvZyhhbm5vdGF0aW9uKVxuICAjICAgIyA9PiB7dGV4dDogJ015IGNvbW1lbnQnLCBwZXJtaXNzaW9uczogey4uLn19XG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIGFkZEZpZWxkc1RvQW5ub3RhdGlvbjogKGFubm90YXRpb24pID0+XG4gICAgaWYgYW5ub3RhdGlvblxuICAgICAgYW5ub3RhdGlvbi5wZXJtaXNzaW9ucyA9IEBvcHRpb25zLnBlcm1pc3Npb25zXG4gICAgICBpZiBAdXNlclxuICAgICAgICBhbm5vdGF0aW9uLnVzZXIgPSBAdXNlclxuXG4gICMgUHVibGljOiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGFjdGlvbiBjYW4gYmUgcGVyZm9ybWVkIG9uIHRoZVxuICAjIGFubm90YXRpb24uIFRoaXMgdXNlcyB0aGUgdXNlci1jb25maWd1cmFibGUgJ3VzZXJBdXRob3JpemUnIG1ldGhvZCB0b1xuICAjIGRldGVybWluZSBpZiBhbiBhbm5vdGF0aW9uIGlzIGFubm90YXRhYmxlLiBTZWUgdGhlIGRlZmF1bHQgbWV0aG9kIGZvclxuICAjIGRvY3VtZW50YXRpb24gb24gaXRzIGJlaGF2aW91ci5cbiAgI1xuICAjIFJldHVybnMgYSBCb29sZWFuLCB0cnVlIGlmIHRoZSBhY3Rpb24gY2FuIGJlIHBlcmZvcm1lZCBvbiB0aGUgYW5ub3RhdGlvbi5cbiAgYXV0aG9yaXplOiAoYWN0aW9uLCBhbm5vdGF0aW9uLCB1c2VyKSAtPlxuICAgIHVzZXIgPSBAdXNlciBpZiB1c2VyID09IHVuZGVmaW5lZFxuXG4gICAgaWYgQG9wdGlvbnMudXNlckF1dGhvcml6ZVxuICAgICAgcmV0dXJuIEBvcHRpb25zLnVzZXJBdXRob3JpemUuY2FsbChAb3B0aW9ucywgYWN0aW9uLCBhbm5vdGF0aW9uLCB1c2VyKVxuXG4gICAgZWxzZSAjIHVzZXJBdXRob3JpemUgbnVsbGVkIG91dDogZnJlZS1mb3ItYWxsIVxuICAgICAgcmV0dXJuIHRydWVcblxuICAjIEZpZWxkIGNhbGxiYWNrOiBVcGRhdGVzIHRoZSBzdGF0ZSBvZiB0aGUgXCJhbnlvbmUgY2Fu4oCmXCIgY2hlY2tib3hlc1xuICAjXG4gICMgYWN0aW9uICAgICAtIFRoZSBhY3Rpb24gU3RyaW5nLCBlaXRoZXIgXCJ2aWV3XCIgb3IgXCJ1cGRhdGVcIlxuICAjIGZpZWxkICAgICAgLSBBIERPTSBFbGVtZW50IGNvbnRhaW5pbmcgYSBmb3JtIGlucHV0LlxuICAjIGFubm90YXRpb24gLSBBbiBhbm5vdGF0aW9uIE9iamVjdC5cbiAgI1xuICAjIFJldHVybnMgbm90aGluZy5cbiAgdXBkYXRlUGVybWlzc2lvbnNGaWVsZDogKGFjdGlvbiwgZmllbGQsIGFubm90YXRpb24pID0+XG4gICAgZmllbGQgPSAkKGZpZWxkKS5zaG93KClcbiAgICBpbnB1dCA9IGZpZWxkLmZpbmQoJ2lucHV0JykucmVtb3ZlQXR0cignZGlzYWJsZWQnKVxuXG4gICAgIyBEbyBub3Qgc2hvdyBmaWVsZCBpZiBjdXJyZW50IHVzZXIgaXMgbm90IGFkbWluLlxuICAgIGZpZWxkLmhpZGUoKSB1bmxlc3MgdGhpcy5hdXRob3JpemUoJ2FkbWluJywgYW5ub3RhdGlvbilcblxuICAgICMgU2VlIGlmIHdlIGNhbiBhdXRob3Jpc2Ugd2l0aG91dCBhIHVzZXIuXG4gICAgaWYgdGhpcy5hdXRob3JpemUoYWN0aW9uLCBhbm5vdGF0aW9uIHx8IHt9LCBudWxsKVxuICAgICAgaW5wdXQuYXR0cignY2hlY2tlZCcsICdjaGVja2VkJylcbiAgICBlbHNlXG4gICAgICBpbnB1dC5yZW1vdmVBdHRyKCdjaGVja2VkJylcblxuXG4gICMgRmllbGQgY2FsbGJhY2s6IHVwZGF0ZXMgdGhlIGFubm90YXRpb24ucGVybWlzc2lvbnMgb2JqZWN0IGJhc2VkIG9uIHRoZSBzdGF0ZVxuICAjIG9mIHRoZSBmaWVsZCBjaGVja2JveC4gSWYgaXQgaXMgY2hlY2tlZCB0aGVuIHBlcm1pc3Npb25zIGFyZSBzZXQgdG8gd29ybGRcbiAgIyB3cml0YWJsZSBvdGhlcndpc2UgdGhleSB1c2UgdGhlIG9yaWdpbmFsIHNldHRpbmdzLlxuICAjXG4gICMgYWN0aW9uICAgICAtIFRoZSBhY3Rpb24gU3RyaW5nLCBlaXRoZXIgXCJ2aWV3XCIgb3IgXCJ1cGRhdGVcIlxuICAjIGZpZWxkICAgICAgLSBBIERPTSBFbGVtZW50IHJlcHJlc2VudGluZyB0aGUgYW5ub3RhdGlvbiBlZGl0b3IuXG4gICMgYW5ub3RhdGlvbiAtIEFuIGFubm90YXRpb24gT2JqZWN0LlxuICAjXG4gICMgUmV0dXJucyBub3RoaW5nLlxuICB1cGRhdGVBbm5vdGF0aW9uUGVybWlzc2lvbnM6ICh0eXBlLCBmaWVsZCwgYW5ub3RhdGlvbikgPT5cbiAgICBhbm5vdGF0aW9uLnBlcm1pc3Npb25zID0gQG9wdGlvbnMucGVybWlzc2lvbnMgdW5sZXNzIGFubm90YXRpb24ucGVybWlzc2lvbnNcblxuICAgIGRhdGFLZXkgPSB0eXBlICsgJy1wZXJtaXNzaW9ucydcblxuICAgIGlmICQoZmllbGQpLmZpbmQoJ2lucHV0JykuaXMoJzpjaGVja2VkJylcbiAgICAgIGFubm90YXRpb24ucGVybWlzc2lvbnNbdHlwZV0gPSBbXVxuICAgIGVsc2VcbiAgICAgICMgQ2xlYXJseSwgdGhlIHBlcm1pc3Npb25zIG1vZGVsIGFsbG93cyBmb3IgbW9yZSBjb21wbGV4IGVudHJpZXMgdGhhblxuICAgICAgIyB0aGlzLCBidXQgb3VyIFVJIHByZXNlbnRzIGEgY2hlY2tib3gsIHNvIHdlIGNhbiBvbmx5IGludGVycHJldCBcInByZXZlbnRcbiAgICAgICMgb3RoZXJzIGZyb20gdmlld2luZ1wiIGFzIG1lYW5pbmcgXCJhbGxvdyBvbmx5IG1lIHRvIHZpZXdcIi4gVGhpcyBtYXkgd2FudFxuICAgICAgIyBjaGFuZ2luZyBpbiB0aGUgZnV0dXJlLlxuICAgICAgYW5ub3RhdGlvbi5wZXJtaXNzaW9uc1t0eXBlXSA9IFtAb3B0aW9ucy51c2VySWQoQHVzZXIpXVxuXG4gICMgRmllbGQgY2FsbGJhY2s6IHVwZGF0ZXMgdGhlIGFubm90YXRpb24gdmlld2VyIHRvIGlubHVkZSB0aGUgZGlzcGxheSBuYW1lXG4gICMgZm9yIHRoZSB1c2VyIG9idGFpbmVkIHRocm91Z2ggUGVybWlzc2lvbnMjb3B0aW9ucy51c2VyU3RyaW5nKCkuXG4gICNcbiAgIyBmaWVsZCAgICAgIC0gQSBESVYgRWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGFubm90YXRpb24gZmllbGQuXG4gICMgYW5ub3RhdGlvbiAtIEFuIGFubm90YXRpb24gT2JqZWN0IHRvIGRpc3BsYXkuXG4gICMgY29udHJvbHMgICAtIEEgY29udHJvbCBPYmplY3QgdG8gdG9nZ2xlIHRoZSBkaXNwbGF5IG9mIGFubm90YXRpb24gY29udHJvbHMuXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIHVwZGF0ZVZpZXdlcjogKGZpZWxkLCBhbm5vdGF0aW9uLCBjb250cm9scykgPT5cbiAgICBmaWVsZCA9ICQoZmllbGQpXG5cbiAgICB1c2VybmFtZSA9IEBvcHRpb25zLnVzZXJTdHJpbmcgYW5ub3RhdGlvbi51c2VyXG4gICAgaWYgYW5ub3RhdGlvbi51c2VyIGFuZCB1c2VybmFtZSBhbmQgdHlwZW9mIHVzZXJuYW1lID09ICdzdHJpbmcnXG4gICAgICB1c2VyID0gQW5ub3RhdG9yLlV0aWwuZXNjYXBlKEBvcHRpb25zLnVzZXJTdHJpbmcoYW5ub3RhdGlvbi51c2VyKSlcbiAgICAgIGZpZWxkLmh0bWwodXNlcikuYWRkQ2xhc3MoJ2Fubm90YXRvci11c2VyJylcbiAgICBlbHNlXG4gICAgICBmaWVsZC5yZW1vdmUoKVxuXG4gICAgaWYgY29udHJvbHNcbiAgICAgIGNvbnRyb2xzLmhpZGVFZGl0KCkgICB1bmxlc3MgdGhpcy5hdXRob3JpemUoJ3VwZGF0ZScsIGFubm90YXRpb24pXG4gICAgICBjb250cm9scy5oaWRlRGVsZXRlKCkgdW5sZXNzIHRoaXMuYXV0aG9yaXplKCdkZWxldGUnLCBhbm5vdGF0aW9uKVxuXG4gICMgU2V0cyB0aGUgUGVybWlzc2lvbnMjdXNlciBwcm9wZXJ0eSBvbiB0aGUgYmFzaXMgb2YgYSByZWNlaXZlZCBhdXRoVG9rZW4uXG4gICNcbiAgIyB0b2tlbiAtIHRoZSBhdXRoVG9rZW4gcmVjZWl2ZWQgYnkgdGhlIEF1dGggcGx1Z2luXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIF9zZXRBdXRoRnJvbVRva2VuOiAodG9rZW4pID0+XG4gICAgdGhpcy5zZXRVc2VyKHRva2VuLnVzZXJJZClcblxuXG5Bbm5vdGF0b3IuUGx1Z2luLnJlZ2lzdGVyKCdQZXJtaXNzaW9ucycsIFBlcm1pc3Npb25zKVxuXG5tb2R1bGUuZXhwb3J0cyA9IFBlcm1pc3Npb25zXG4iXX0=