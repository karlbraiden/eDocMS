/*
** Annotator v2.0.0-dev-41928d6
** https://github.com/okfn/annotator/
**
** Copyright 2014, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2014-04-11 02:53:36Z
*/
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self);var o=n;o=o.Annotator||(o.Annotator={}),o=o.Plugin||(o.Plugin={}),o.Document=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"4hR4NO":[function(_dereq_,module,exports){
(function (global){
var Annotator, self, _ref;

if (typeof self !== "undefined" && self !== null) {
  self = self;
}

if (typeof global !== "undefined" && global !== null) {
  if (self == null) {
    self = global;
  }
}

if (typeof window !== "undefined" && window !== null) {
  if (self == null) {
    self = window;
  }
}

Annotator = self != null ? self.Annotator : void 0;

if (Annotator == null) {
  Annotator = (self != null ? (_ref = self.define) != null ? _ref.amd : void 0 : void 0) ? self != null ? self.require('annotator') : void 0 : void 0;
}

if (typeof Annotator !== 'function') {
  throw new Error("Could not find Annotator! In a webpage context, please ensure that the Annotator script tag is loaded before any plugins.");
}

module.exports = Annotator;


}).call(this,typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],"annotator":[function(_dereq_,module,exports){
module.exports=_dereq_('4hR4NO');
},{}],3:[function(_dereq_,module,exports){
var $, Annotator, Document,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Annotator = _dereq_('annotator');

$ = Annotator.Util.$;

Document = (function(_super) {
  __extends(Document, _super);

  function Document() {
    this._getFavicon = __bind(this._getFavicon, this);
    this._getLinks = __bind(this._getLinks, this);
    this._getTitle = __bind(this._getTitle, this);
    this._getEprints = __bind(this._getEprints, this);
    this._getPrism = __bind(this._getPrism, this);
    this._getDublinCore = __bind(this._getDublinCore, this);
    this._getTwitter = __bind(this._getTwitter, this);
    this._getFacebook = __bind(this._getFacebook, this);
    this._getHighwire = __bind(this._getHighwire, this);
    this.getDocumentMetadata = __bind(this.getDocumentMetadata, this);
    this.uris = __bind(this.uris, this);
    this.uri = __bind(this.uri, this);
    return Document.__super__.constructor.apply(this, arguments);
  }

  Document.prototype.pluginInit = function() {
    this.getDocumentMetadata();
    return this.listenTo(this.annotator, 'beforeAnnotationCreated', this.beforeAnnotationCreated);
  };

  Document.prototype.uri = function() {
    var link, uri, _i, _len, _ref;
    uri = decodeURIComponent(document.location.href);
    _ref = this.metadata;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      link = _ref[_i];
      if (link.rel === "canonical") {
        uri = link.href;
      }
    }
    return uri;
  };

  Document.prototype.uris = function() {
    var href, link, uniqueUrls, _i, _len, _ref;
    uniqueUrls = {};
    _ref = this.metadata.link;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      link = _ref[_i];
      if (link.href) {
        uniqueUrls[link.href] = true;
      }
    }
    return (function() {
      var _results;
      _results = [];
      for (href in uniqueUrls) {
        _results.push(href);
      }
      return _results;
    })();
  };

  Document.prototype.beforeAnnotationCreated = function(annotation) {
    return annotation.document = this.metadata;
  };

  Document.prototype.getDocumentMetadata = function() {
    this.metadata = {};
    this._getHighwire();
    this._getDublinCore();
    this._getFacebook();
    this._getEprints();
    this._getPrism();
    this._getTwitter();
    this._getFavicon();
    this._getTitle();
    this._getLinks();
    return this.metadata;
  };

  Document.prototype._getHighwire = function() {
    return this.metadata.highwire = this._getMetaTags("citation", "name", "_");
  };

  Document.prototype._getFacebook = function() {
    return this.metadata.facebook = this._getMetaTags("og", "property", ":");
  };

  Document.prototype._getTwitter = function() {
    return this.metadata.twitter = this._getMetaTags("twitter", "name", ":");
  };

  Document.prototype._getDublinCore = function() {
    return this.metadata.dc = this._getMetaTags("dc", "name", ".");
  };

  Document.prototype._getPrism = function() {
    return this.metadata.prism = this._getMetaTags("prism", "name", ".");
  };

  Document.prototype._getEprints = function() {
    return this.metadata.eprints = this._getMetaTags("eprints", "name", ".");
  };

  Document.prototype._getMetaTags = function(prefix, attribute, delimiter) {
    var content, match, meta, n, name, tags, _i, _len, _ref;
    tags = {};
    _ref = $("meta");
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      meta = _ref[_i];
      name = $(meta).attr(attribute);
      content = $(meta).prop("content");
      if (name) {
        match = name.match(RegExp("^" + prefix + delimiter + "(.+)$", "i"));
        if (match) {
          n = match[1];
          if (tags[n]) {
            tags[n].push(content);
          } else {
            tags[n] = [content];
          }
        }
      }
    }
    return tags;
  };

  Document.prototype._getTitle = function() {
    if (this.metadata.highwire.title) {
      return this.metadata.title = this.metadata.highwire.title[0];
    } else if (this.metadata.eprints.title) {
      return this.metadata.title = this.metadata.eprints.title;
    } else if (this.metadata.prism.title) {
      return this.metadata.title = this.metadata.prism.title;
    } else if (this.metadata.facebook.title) {
      return this.metadata.title = this.metadata.facebook.title;
    } else if (this.metadata.twitter.title) {
      return this.metadata.title = this.metadata.twitter.title;
    } else if (this.metadata.dc.title) {
      return this.metadata.title = this.metadata.dc.title;
    } else {
      return this.metadata.title = $("head title").text();
    }
  };

  Document.prototype._getLinks = function() {
    var doi, href, id, l, lang, link, name, rel, type, url, values, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _results;
    this.metadata.link = [
      {
        href: document.location.href
      }
    ];
    _ref = $("link");
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      link = _ref[_i];
      l = $(link);
      href = this._absoluteUrl(l.prop('href'));
      rel = l.prop('rel');
      type = l.prop('type');
      lang = l.prop('hreflang');
      if (rel !== "alternate" && rel !== "canonical" && rel !== "bookmark") {
        continue;
      }
      if (rel === 'alternate') {
        if (type && type.match(/^application\/(rss|atom)\+xml/)) {
          continue;
        }
        if (lang) {
          continue;
        }
      }
      this.metadata.link.push({
        href: href,
        rel: rel,
        type: type
      });
    }
    _ref1 = this.metadata.highwire;
    for (name in _ref1) {
      values = _ref1[name];
      if (name === "pdf_url") {
        for (_j = 0, _len1 = values.length; _j < _len1; _j++) {
          url = values[_j];
          this.metadata.link.push({
            href: this._absoluteUrl(url),
            type: "application/pdf"
          });
        }
      }
      if (name === "doi") {
        for (_k = 0, _len2 = values.length; _k < _len2; _k++) {
          doi = values[_k];
          if (doi.slice(0, 4) !== "doi:") {
            doi = "doi:" + doi;
          }
          this.metadata.link.push({
            href: doi
          });
        }
      }
    }
    _ref2 = this.metadata.dc;
    _results = [];
    for (name in _ref2) {
      values = _ref2[name];
      if (name === "identifier") {
        _results.push((function() {
          var _l, _len3, _results1;
          _results1 = [];
          for (_l = 0, _len3 = values.length; _l < _len3; _l++) {
            id = values[_l];
            if (id.slice(0, 4) === "doi:") {
              _results1.push(this.metadata.link.push({
                href: id
              }));
            } else {
              _results1.push(void 0);
            }
          }
          return _results1;
        }).call(this));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Document.prototype._getFavicon = function() {
    var link, _i, _len, _ref, _ref1, _results;
    _ref = $("link");
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      link = _ref[_i];
      if ((_ref1 = $(link).prop("rel")) === "shortcut icon" || _ref1 === "icon") {
        _results.push(this.metadata["favicon"] = this._absoluteUrl(link.href));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Document.prototype._absoluteUrl = function(url) {
    var d;
    d = document.createElement('a');
    d.href = url;
    return d.href;
  };

  return Document;

})(Annotator.Plugin);

Annotator.Plugin.register('Document', Document);

module.exports = Document;


},{}]},{},[3])

(3)
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnL2Fubm90YXRvci5kb2N1bWVudC5qcyIsInNvdXJjZXMiOlsiLi4vbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsIm5hbWVzcGFjZS5jb2ZmZWUiLCJwbHVnaW4vZG9jdW1lbnQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTtBQ0tBOzs7U0FBTyxJQUFQOzs7QUFDQTs7V0FBUTtHQUFSO0NBREE7O0FBRUE7O1dBQVE7R0FBUjtDQUZBOzs7OztFQU1BLHNCQUFhO0NBTmI7O0FBVUE7QUFDRSxRQUFVLFVBQU0sb0JBRGxCO0NBVkE7Ozs7Ozs7Ozs7QUNMQTs7Ozs7WUFBWSxRQUFRLFdBQVIsQ0FBWjs7Q0FDQSxHQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FEbkI7OztBQUtFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7a0NBQVk7QUFDVixRQUFJLENBQUMsbUJBQUw7V0FDQSxJQUFJLENBQUMsUUFBTCxDQUFjLElBQUMsVUFBZixFQUEwQix5QkFBMUIsRUFDRSxJQUFJLENBQUMsdUJBRFAsRUFGVTtHQUFaOztxQkFNQSxNQUFLO0FBQ0g7VUFBTSxtQkFBbUIsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFyQyxDQUFOO0FBQ0E7OztBQUNFLFVBQUcsSUFBSSxDQUFDLEdBQUwsS0FBWSxXQUFmO0FBQ0UsY0FBTSxJQUFJLENBQUMsSUFBWCxDQURGO09BREY7S0FEQTtBQUlBLFdBQU8sR0FBUCxDQUxHO0dBTkw7O3FCQWVBLE9BQU07QUFDSjtpQkFBYSxFQUFiO0FBQ0E7OztBQUNFLFVBQWdDLElBQUksQ0FBQyxJQUFyQztrQkFBVyxLQUFJLENBQUMsSUFBTCxDQUFYLEdBQXdCLElBQXhCO09BREY7S0FEQTtBQUdBOztBQUFROzs7OztRQUFSLENBSkk7R0FmTjs7cUJBcUJBLDBCQUF5QixTQUFDLFVBQUQ7V0FDdkIsVUFBVSxDQUFDLFFBQVgsR0FBc0IsSUFBQyxVQURBO0dB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UUFBakIsQ0FBMEIsVUFBMUIsRUFBc0MsUUFBdEMsQ0E3SkE7O01BK0pNLENBQUMsT0FBUCxHQUFpQixRQS9KakIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3Rocm93IG5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIil9dmFyIGY9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGYuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sZixmLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIiMgSW4gb3JkZXIgdG8gYnVpbGQgcG9ydGFibGUgZXh0ZW5zaW9uIGJ1bmRsZXMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIEFNRCBhbmRcbiMgc2NyaXB0IGNvbmNhdGVuYXRpb24gcGx1Z2lucyBhcmUgYnVpbHQgd2l0aCB0aGlzIG1vZHVsZSBhcyAnYW5ub3RhdG9yJy5cblxuIyBBbm5vdGF0b3Igd2lsbCBleHBvcnQgaXRzZWxmIGdsb2JhbGx5IHdoZW4gdGhlIGJ1aWx0IFVNRCBtb2R1bGVzIGFyZSB1c2VkIGluXG4jIGEgbGVnYWN5IGVudmlyb25tZW50IG9mIHNpbXBsZSBzY3JpcHQgY29uY2F0ZW5hdGlvbi5cbnNlbGYgPSBzZWxmIGlmIHNlbGY/XG5zZWxmID89IGdsb2JhbCBpZiBnbG9iYWw/XG5zZWxmID89IHdpbmRvdyBpZiB3aW5kb3c/XG5Bbm5vdGF0b3IgPSBzZWxmPy5Bbm5vdGF0b3JcblxuIyBJbiBhIHB1cmUgQU1EIGVudmlyb25tZW50LCBBbm5vdGF0b3IgbWF5IG5vdCBiZSBleHBvcnRlZCBnbG9iYWxseS5cbkFubm90YXRvciA/PSBpZiBzZWxmPy5kZWZpbmU/LmFtZCB0aGVuIHNlbGY/LnJlcXVpcmUoJ2Fubm90YXRvcicpXG5cbiMgSWYgd2UgaGF2ZW4ndCBzdWNjZXNzZnVsbHkgbG9hZGVkIEFubm90YXRvciBieSB0aGlzIHBvaW50LCB0aGVyZSdzIG5vIHBvaW50IGluXG4jIGdvaW5nIG9uIHRvIGxvYWQgdGhlIHBsdWdpbiwgc28gdGhyb3cgYSBmYXRhbCBlcnJvci5cbmlmIHR5cGVvZiBBbm5vdGF0b3IgaXNudCAnZnVuY3Rpb24nXG4gIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCBmaW5kIEFubm90YXRvciEgSW4gYSB3ZWJwYWdlIGNvbnRleHQsIHBsZWFzZSBlbnN1cmVcbiAgICAgICAgICAgICAgICAgICB0aGF0IHRoZSBBbm5vdGF0b3Igc2NyaXB0IHRhZyBpcyBsb2FkZWQgYmVmb3JlIGFueSBwbHVnaW5zLlwiKVxuXG4jIE5vdGU6IHdoZW4gd29ya2luZyBpbiBhIENvbW1vbkpTIGVudmlyb25tZW50IGFuZCBidW5kbGluZyByZXF1aXJlbWVudHMgaW50b1xuIyBhcHBsaWNhdGlvbnMgdGhlbiByZXF1aXJlIGNhbGxzIHNob3VsZCByZWZlciB0byBtb2R1bGVzIGZyb20gdGhlIG5wbSBsaWJcbiMgZGlyZWN0b3J5IG9mIGFubm90YXRvciBwYWNrYWdlIGFuZCBhdm9pZCB0aGlzIGFsdG9nZXRoZXIuXG5tb2R1bGUuZXhwb3J0cyA9IEFubm90YXRvclxuIiwiQW5ub3RhdG9yID0gcmVxdWlyZSgnYW5ub3RhdG9yJylcbiQgPSBBbm5vdGF0b3IuVXRpbC4kXG5cblxuY2xhc3MgRG9jdW1lbnQgZXh0ZW5kcyBBbm5vdGF0b3IuUGx1Z2luXG4gIHBsdWdpbkluaXQ6IC0+XG4gICAgdGhpcy5nZXREb2N1bWVudE1ldGFkYXRhKClcbiAgICB0aGlzLmxpc3RlblRvKEBhbm5vdGF0b3IsICdiZWZvcmVBbm5vdGF0aW9uQ3JlYXRlZCcsXG4gICAgICB0aGlzLmJlZm9yZUFubm90YXRpb25DcmVhdGVkKVxuXG4gICMgcmV0dXJucyB0aGUgcHJpbWFyeSBVUkkgZm9yIHRoZSBkb2N1bWVudCBiZWluZyBhbm5vdGF0ZWRcbiAgdXJpOiA9PlxuICAgIHVyaSA9IGRlY29kZVVSSUNvbXBvbmVudCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmXG4gICAgZm9yIGxpbmsgaW4gQG1ldGFkYXRhXG4gICAgICBpZiBsaW5rLnJlbCA9PSBcImNhbm9uaWNhbFwiXG4gICAgICAgIHVyaSA9IGxpbmsuaHJlZlxuICAgIHJldHVybiB1cmlcblxuICAjIHJldHVybnMgYWxsIHVyaXMgZm9yIHRoZSBkb2N1bWVudCBiZWluZyBhbm5vdGF0ZWRcblxuICB1cmlzOiA9PlxuICAgIHVuaXF1ZVVybHMgPSB7fVxuICAgIGZvciBsaW5rIGluIEBtZXRhZGF0YS5saW5rXG4gICAgICB1bmlxdWVVcmxzW2xpbmsuaHJlZl0gPSB0cnVlIGlmIGxpbmsuaHJlZlxuICAgIHJldHVybiAoaHJlZiBmb3IgaHJlZiBvZiB1bmlxdWVVcmxzKVxuXG4gIGJlZm9yZUFubm90YXRpb25DcmVhdGVkOiAoYW5ub3RhdGlvbikgLT5cbiAgICBhbm5vdGF0aW9uLmRvY3VtZW50ID0gQG1ldGFkYXRhXG5cbiAgZ2V0RG9jdW1lbnRNZXRhZGF0YTogPT5cbiAgICBAbWV0YWRhdGEgPSB7fVxuXG4gICAgIyBmaXJzdCBsb29rIGZvciBzb21lIGNvbW1vbiBtZXRhZGF0YSB0eXBlc1xuICAgICMgVE9ETzogbG9vayBmb3IgbWljcm9kYXRhL3JkZmE/XG4gICAgdGhpcy5fZ2V0SGlnaHdpcmUoKVxuICAgIHRoaXMuX2dldER1YmxpbkNvcmUoKVxuICAgIHRoaXMuX2dldEZhY2Vib29rKClcbiAgICB0aGlzLl9nZXRFcHJpbnRzKClcbiAgICB0aGlzLl9nZXRQcmlzbSgpXG4gICAgdGhpcy5fZ2V0VHdpdHRlcigpXG4gICAgdGhpcy5fZ2V0RmF2aWNvbigpXG5cbiAgICAjIGV4dHJhY3Qgb3V0L25vcm1hbGl6ZSBzb21lIHRoaW5nc1xuICAgIHRoaXMuX2dldFRpdGxlKClcbiAgICB0aGlzLl9nZXRMaW5rcygpXG5cbiAgICByZXR1cm4gQG1ldGFkYXRhXG5cbiAgX2dldEhpZ2h3aXJlOiA9PlxuICAgIHJldHVybiBAbWV0YWRhdGEuaGlnaHdpcmUgPSB0aGlzLl9nZXRNZXRhVGFncyhcImNpdGF0aW9uXCIsIFwibmFtZVwiLCBcIl9cIilcblxuICBfZ2V0RmFjZWJvb2s6ID0+XG4gICAgcmV0dXJuIEBtZXRhZGF0YS5mYWNlYm9vayA9IHRoaXMuX2dldE1ldGFUYWdzKFwib2dcIiwgXCJwcm9wZXJ0eVwiLCBcIjpcIilcblxuICBfZ2V0VHdpdHRlcjogPT5cbiAgICByZXR1cm4gQG1ldGFkYXRhLnR3aXR0ZXIgPSB0aGlzLl9nZXRNZXRhVGFncyhcInR3aXR0ZXJcIiwgXCJuYW1lXCIsIFwiOlwiKVxuXG4gIF9nZXREdWJsaW5Db3JlOiA9PlxuICAgIHJldHVybiBAbWV0YWRhdGEuZGMgPSB0aGlzLl9nZXRNZXRhVGFncyhcImRjXCIsIFwibmFtZVwiLCBcIi5cIilcblxuICBfZ2V0UHJpc206ID0+XG4gICAgcmV0dXJuIEBtZXRhZGF0YS5wcmlzbSA9IHRoaXMuX2dldE1ldGFUYWdzKFwicHJpc21cIiwgXCJuYW1lXCIsIFwiLlwiKVxuXG4gIF9nZXRFcHJpbnRzOiA9PlxuICAgIHJldHVybiBAbWV0YWRhdGEuZXByaW50cyA9IHRoaXMuX2dldE1ldGFUYWdzKFwiZXByaW50c1wiLCBcIm5hbWVcIiwgXCIuXCIpXG5cbiAgX2dldE1ldGFUYWdzOiAocHJlZml4LCBhdHRyaWJ1dGUsIGRlbGltaXRlcikgLT5cbiAgICB0YWdzID0ge31cbiAgICBmb3IgbWV0YSBpbiAkKFwibWV0YVwiKVxuICAgICAgbmFtZSA9ICQobWV0YSkuYXR0cihhdHRyaWJ1dGUpXG4gICAgICBjb250ZW50ID0gJChtZXRhKS5wcm9wKFwiY29udGVudFwiKVxuICAgICAgaWYgbmFtZVxuICAgICAgICBtYXRjaCA9IG5hbWUubWF0Y2goUmVnRXhwKFwiXiN7cHJlZml4fSN7ZGVsaW1pdGVyfSguKykkXCIsIFwiaVwiKSlcbiAgICAgICAgaWYgbWF0Y2hcbiAgICAgICAgICBuID0gbWF0Y2hbMV1cbiAgICAgICAgICBpZiB0YWdzW25dXG4gICAgICAgICAgICB0YWdzW25dLnB1c2goY29udGVudClcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICB0YWdzW25dID0gW2NvbnRlbnRdXG4gICAgcmV0dXJuIHRhZ3NcblxuICBfZ2V0VGl0bGU6ID0+XG4gICAgaWYgQG1ldGFkYXRhLmhpZ2h3aXJlLnRpdGxlXG4gICAgICBAbWV0YWRhdGEudGl0bGUgPSBAbWV0YWRhdGEuaGlnaHdpcmUudGl0bGVbMF1cbiAgICBlbHNlIGlmIEBtZXRhZGF0YS5lcHJpbnRzLnRpdGxlXG4gICAgICBAbWV0YWRhdGEudGl0bGUgPSBAbWV0YWRhdGEuZXByaW50cy50aXRsZVxuICAgIGVsc2UgaWYgQG1ldGFkYXRhLnByaXNtLnRpdGxlXG4gICAgICBAbWV0YWRhdGEudGl0bGUgPSBAbWV0YWRhdGEucHJpc20udGl0bGVcbiAgICBlbHNlIGlmIEBtZXRhZGF0YS5mYWNlYm9vay50aXRsZVxuICAgICAgQG1ldGFkYXRhLnRpdGxlID0gQG1ldGFkYXRhLmZhY2Vib29rLnRpdGxlXG4gICAgZWxzZSBpZiBAbWV0YWRhdGEudHdpdHRlci50aXRsZVxuICAgICAgQG1ldGFkYXRhLnRpdGxlID0gQG1ldGFkYXRhLnR3aXR0ZXIudGl0bGVcbiAgICBlbHNlIGlmIEBtZXRhZGF0YS5kYy50aXRsZVxuICAgICAgQG1ldGFkYXRhLnRpdGxlID0gQG1ldGFkYXRhLmRjLnRpdGxlXG4gICAgZWxzZVxuICAgICAgQG1ldGFkYXRhLnRpdGxlID0gJChcImhlYWQgdGl0bGVcIikudGV4dCgpXG5cbiAgX2dldExpbmtzOiA9PlxuICAgICMgd2Uga25vdyBvdXIgY3VycmVudCBsb2NhdGlvbiBpcyBhIGxpbmsgZm9yIHRoZSBkb2N1bWVudFxuICAgIEBtZXRhZGF0YS5saW5rID0gW2hyZWY6IGRvY3VtZW50LmxvY2F0aW9uLmhyZWZdXG5cbiAgICAjIGxvb2sgZm9yIHNvbWUgcmVsZXZhbnQgbGluayByZWxhdGlvbnNcbiAgICBmb3IgbGluayBpbiAkKFwibGlua1wiKVxuICAgICAgbCA9ICQobGluaylcbiAgICAgIGhyZWYgPSB0aGlzLl9hYnNvbHV0ZVVybChsLnByb3AoJ2hyZWYnKSkgIyBnZXQgYWJzb2x1dGUgdXJsXG4gICAgICByZWwgPSBsLnByb3AoJ3JlbCcpXG4gICAgICB0eXBlID0gbC5wcm9wKCd0eXBlJylcbiAgICAgIGxhbmcgPSBsLnByb3AoJ2hyZWZsYW5nJylcblxuICAgICAgaWYgcmVsIG5vdCBpbiBbXCJhbHRlcm5hdGVcIiwgXCJjYW5vbmljYWxcIiwgXCJib29rbWFya1wiXSB0aGVuIGNvbnRpbnVlXG5cbiAgICAgIGlmIHJlbCBpcyAnYWx0ZXJuYXRlJ1xuICAgICAgICAjIElnbm9yZSBmZWVkcyByZXNvdXJjZXNcbiAgICAgICAgaWYgdHlwZSBhbmQgdHlwZS5tYXRjaCAvXmFwcGxpY2F0aW9uXFwvKHJzc3xhdG9tKVxcK3htbC8gdGhlbiBjb250aW51ZVxuICAgICAgICAjIElnbm9yZSBhbHRlcm5hdGUgbGFuZ3VhZ2VzXG4gICAgICAgIGlmIGxhbmcgdGhlbiBjb250aW51ZVxuXG4gICAgICBAbWV0YWRhdGEubGluay5wdXNoKGhyZWY6IGhyZWYsIHJlbDogcmVsLCB0eXBlOiB0eXBlKVxuXG4gICAgIyBsb29rIGZvciBsaW5rcyBpbiBzY2hvbGFyIG1ldGFkYXRhXG4gICAgZm9yIG5hbWUsIHZhbHVlcyBvZiBAbWV0YWRhdGEuaGlnaHdpcmVcblxuICAgICAgaWYgbmFtZSA9PSBcInBkZl91cmxcIlxuICAgICAgICBmb3IgdXJsIGluIHZhbHVlc1xuICAgICAgICAgIEBtZXRhZGF0YS5saW5rLnB1c2hcbiAgICAgICAgICAgIGhyZWY6IHRoaXMuX2Fic29sdXRlVXJsKHVybClcbiAgICAgICAgICAgIHR5cGU6IFwiYXBwbGljYXRpb24vcGRmXCJcblxuICAgICAgIyBraW5kIG9mIGEgaGFjayB0byBleHByZXNzIERPSSBpZGVudGlmaWVycyBhcyBsaW5rcyBidXQgaXQncyBhXG4gICAgICAjIGNvbnZlbmllbnQgcGxhY2UgdG8gbG9vayB0aGVtIHVwIGxhdGVyLCBhbmQgc29tZXdoYXQgc2FuZSBzaW5jZVxuICAgICAgIyB0aGV5IGRvbid0IGhhdmUgYSB0eXBlXG5cbiAgICAgIGlmIG5hbWUgPT0gXCJkb2lcIlxuICAgICAgICBmb3IgZG9pIGluIHZhbHVlc1xuICAgICAgICAgIGlmIGRvaVswLi4zXSAhPSBcImRvaTpcIlxuICAgICAgICAgICAgZG9pID0gXCJkb2k6XCIgKyBkb2lcbiAgICAgICAgICBAbWV0YWRhdGEubGluay5wdXNoKGhyZWY6IGRvaSlcblxuICAgICMgbG9vayBmb3IgbGlua3MgaW4gZHVibGluY29yZSBkYXRhXG4gICAgZm9yIG5hbWUsIHZhbHVlcyBvZiBAbWV0YWRhdGEuZGNcbiAgICAgIGlmIG5hbWUgPT0gXCJpZGVudGlmaWVyXCJcbiAgICAgICAgZm9yIGlkIGluIHZhbHVlc1xuICAgICAgICAgIGlmIGlkWzAuLjNdID09IFwiZG9pOlwiXG4gICAgICAgICAgICBAbWV0YWRhdGEubGluay5wdXNoKGhyZWY6IGlkKVxuXG4gIF9nZXRGYXZpY29uOiA9PlxuICAgIGZvciBsaW5rIGluICQoXCJsaW5rXCIpXG4gICAgICBpZiAkKGxpbmspLnByb3AoXCJyZWxcIikgaW4gW1wic2hvcnRjdXQgaWNvblwiLCBcImljb25cIl1cbiAgICAgICAgQG1ldGFkYXRhW1wiZmF2aWNvblwiXSA9IHRoaXMuX2Fic29sdXRlVXJsKGxpbmsuaHJlZilcblxuICAjIGhhY2sgdG8gZ2V0IGEgYWJzb2x1dGUgdXJsIGZyb20gYSBwb3NzaWJseSByZWxhdGl2ZSBvbmVcblxuICBfYWJzb2x1dGVVcmw6ICh1cmwpIC0+XG4gICAgZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKVxuICAgIGQuaHJlZiA9IHVybFxuICAgIGQuaHJlZlxuXG5Bbm5vdGF0b3IuUGx1Z2luLnJlZ2lzdGVyKCdEb2N1bWVudCcsIERvY3VtZW50KVxuXG5tb2R1bGUuZXhwb3J0cyA9IERvY3VtZW50XG4iXX0=