/*
** Annotator v2.0.0-dev-41928d6
** https://github.com/okfn/annotator/
**
** Copyright 2014, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2014-04-11 02:54:04Z
*/
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/*
Annotator Bookmarklet
=====================

A Javascript bookmarklet wrapper around the Annotator plugin. This allows the
user to load the annotator into any web page and post the annotations to a
server (by default this is [AnnotateIt][#annotateit]).

The bookmarklet version of the annotator has the following plugins loaded:

 - [Auth][#wiki-auth]: authenticates with [AnnotateIt][#annotateit]
 - [Store][#wiki-store]: saves to [AnnotateIt][#annotateit]
 - [Permissions][#wiki-permissions]
 - [Unsupported][#wiki-unsupported]: displays a notification if the bookmarklet is run on an
   unsupported browser

and optionally, the [Tags plugin][#wiki-tags].

Configuration
-------------

In order to configure the bookmarklet for your needs it accepts `config` hash of
options. These are set in the _config.json_ file. There's an example in the
repository (see _config.example.json_). The options are as follows:

### externals

 - `source`: The generated Annotator Javascript source code (see Development)
 - `styles`: The generated Annotator CSS source code (see Development)

### auth

Settings for the [Auth plugin][#wiki-auth]

- `tokenUrl`: The URL of the auth token generator to use (default: http://annotateit.org/api/token)

### store

Settings for the [Store plugin][#wiki-store].

 - `prefix`: The prefix URL for the store (default: http://annotateit.org/api)

### permissions

Settings for the [Permissions plugin][#wiki-permissions].

#### tags

If this is set to `true` the [Tags plugin][#wiki-tags] will be loaded.
*/
(function (options, window, document) {
  "use strict";

  var body = document.body,
      head = document.getElementsByTagName('head')[0],
      globals = ['Annotator'],
      isLoaded = {},
      bookmarklet = {},
      notification, namespace;

  while (globals.length) {
    namespace = globals.shift();
    isLoaded[namespace] = window.hasOwnProperty(namespace);
  }

  notification = (function () {
    var element = document.createElement('div'),
        transition = 'top 0.4s ease-out',
        styles  = {
          display: 'block',
          position: 'absolute',
          fontFamily: '"Helvetica Neue", Arial, Helvetica, sans-serif',
          fontSize: '14px',
          color: '#fff',
          top: '-54px',
          left: 0,
          width: '100%',
          zIndex: 9999,
          lineHeight: '50px',
          textAlign: 'center',
          backgroundColor: '#000',
          borderBottom: '4px solid',
          WebkitTransition: transition,
          MozTransition: transition,
          OTransition: transition,
          transition: transition
        }, property;

    element.className = 'annotator-bm-status';
    for (property in styles) {
      if (styles.hasOwnProperty(property)) {
        element.style[property] = styles[property];
      }
    }

    // Apply newer styles for modern browsers.
    element.style.position = 'fixed';
    element.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
    element.onclick = function () {
      this.parentNode.removeChild(this);
    };

    return {
      status: {
        INFO:    '#d4d4d4',
        SUCCESS: '#3665f9',
        ERROR:   '#ff7e00'
      },
      element: element,
      show: function (message, status) {
        this.message(message, status);

        element.style.display = 'block';
        element.style.visibility = 'visible';
        element.style.top = '0';

        return this;
      },
      hide: function () {
        element.style.top = '-54px';

        setTimeout(function () {
          element.style.display = 'none';
          element.style.visibility = 'hidden';
        }, 400);

        return this;
      },
      message: function (message, status) {
        status = status || this.status.INFO;

        element.style.borderColor = status;
        element.innerHTML = message;

        return this;
      },
      error: function (message) {
        this.message(message, this.status.ERROR);
        setTimeout(this.hide, 5000);
        setTimeout(this.remove, 5500);
      },
      append: function () {
        body.appendChild(element);
        return this;
      },
      remove: function () {
        var parent = element.parentNode;
        if (parent) {
          parent.removeChild(element);
        }
        return this;
      }
    }.append();
  }());

  bookmarklet = {
    notification: notification,

    keypath: function (object, path, fallback) {
      var keys = (path || '').split('.'),
          key;

      while (object && keys.length) {
        key = keys.shift();

        if (object.hasOwnProperty(key)) {
          object = object[key];

          if (keys.length === 0 && object !== undefined) {
            return object;
          }
        } else {
          break;
        }
      }

      return (fallback === null) ? null : fallback;
    },

    config: function (path, fallback) {
      var value = this.keypath(options, path, fallback);

      if (value === null) {
        notification.error('Sorry, there was an error reading the bookmarklet setting for key: ' + path);
      }

      return value;
    },

    _injectElement: function (where, el) {
      if (where == 'head') {
        head.appendChild(el);
      } else {
        body.appendChild(el);
      }
    },

    load: function (callback) {
      var annotatorSource = this.config('externals.source', 'http://assets.annotateit.org/bookmarklet/annotator-bookmarklet.min.js'),
          annotatorStyles = this.config('externals.styles', 'http://assets.annotateit.org/bookmarklet/annotator.min.css');

      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = annotatorStyles;

      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = annotatorSource;
      script._loaded = false;

      var scriptLoaded = function () {
        script._loaded = true;
        callback();
      };

      script.onload = scriptLoaded;
      script.onreadystatechange = function() {
        if ( this.readyState !== "loaded" && !script._loaded ) return;
        scriptLoaded();
      };

      setTimeout(function () {
        if (!script._loaded) {
          notification.error('Sorry, we\'re unable to load Annotator at the moment...');
        }
      }, 30000);

      this._injectElement('head', link);
      this._injectElement('body', script);
    },

    authOptions: function () {
      return {
        tokenUrl: this.config('auth.tokenUrl', 'http://annotateit.org/api/token'),
        autoFetch: this.config('auth.autoFetch', true)
      };
    },

    storeOptions: function () {
      var uri = location.href.split(/#|\?/).shift();
      return {
        prefix: this.config('store.prefix', 'http://annotateit.org/api'),
        annotationData: { 'uri': uri },
        loadFromSearch: { 'uri': uri }
      };
    },

    annotateItPermissionsOptions: function () {
      return this.config('annotateItPermissions', {});
    },

    setup: function () {
      var annotator = new window.Annotator(options.target || body),
        jQuery = window.Annotator.Util.$,
        namespace;

      annotator
        .addPlugin('Unsupported')
        .addPlugin('Auth', this.authOptions())
        .addPlugin('Store', this.storeOptions())
        .addPlugin('AnnotateItPermissions', this.annotateItPermissionsOptions());

      if (this.config('tags') === true) {
          annotator.addPlugin('Tags');
      }

      // Attach the annotator to the window object so we can prevent it
      // being loaded twice and test.
      jQuery.extend(window._annotator, {
        jQuery: jQuery,
        element: body,
        instance: annotator,
        Annotator: window.Annotator.noConflict()
      });

      // Clean up after ourselves by removing any properties on window that
      // were not there before.
      for (namespace in isLoaded) {
        if (isLoaded.hasOwnProperty(namespace) && !isLoaded[namespace]) {
          delete window[namespace];
        }
      }

      notification.message('Annotator is ready!', notification.status.SUCCESS);
      setTimeout(function () {
        notification.hide();
        setTimeout(notification.remove, 800);
      }, 3000);
    },

    init: function () {
      if (window._annotator.instance) {
        window._annotator.Annotator.showNotification(
          'Annotator is already loaded. Try highlighting some text to get started.'
        );
      } else {
        notification.show('Loading Annotator into page');
        bookmarklet.load(function () {
          bookmarklet.setup();
        });
      }
    }
  };

  // Export the bookmarklet to the window object for testing.
  if (!window._annotator) {
    window._annotator = {
      bookmarklet: bookmarklet
    };
  }

  // Load the bookmarklet.
  if (!options.test) {
    bookmarklet.init();
  }
}(window._annotatorConfig, window, window.document));

},{}]},{},[1])


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnL2Jvb3RzdHJhcC5qcyIsInNvdXJjZXMiOlsiLi4vbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsImJvb3RzdHJhcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvKlxuQW5ub3RhdG9yIEJvb2ttYXJrbGV0XG49PT09PT09PT09PT09PT09PT09PT1cblxuQSBKYXZhc2NyaXB0IGJvb2ttYXJrbGV0IHdyYXBwZXIgYXJvdW5kIHRoZSBBbm5vdGF0b3IgcGx1Z2luLiBUaGlzIGFsbG93cyB0aGVcbnVzZXIgdG8gbG9hZCB0aGUgYW5ub3RhdG9yIGludG8gYW55IHdlYiBwYWdlIGFuZCBwb3N0IHRoZSBhbm5vdGF0aW9ucyB0byBhXG5zZXJ2ZXIgKGJ5IGRlZmF1bHQgdGhpcyBpcyBbQW5ub3RhdGVJdF1bI2Fubm90YXRlaXRdKS5cblxuVGhlIGJvb2ttYXJrbGV0IHZlcnNpb24gb2YgdGhlIGFubm90YXRvciBoYXMgdGhlIGZvbGxvd2luZyBwbHVnaW5zIGxvYWRlZDpcblxuIC0gW0F1dGhdWyN3aWtpLWF1dGhdOiBhdXRoZW50aWNhdGVzIHdpdGggW0Fubm90YXRlSXRdWyNhbm5vdGF0ZWl0XVxuIC0gW1N0b3JlXVsjd2lraS1zdG9yZV06IHNhdmVzIHRvIFtBbm5vdGF0ZUl0XVsjYW5ub3RhdGVpdF1cbiAtIFtQZXJtaXNzaW9uc11bI3dpa2ktcGVybWlzc2lvbnNdXG4gLSBbVW5zdXBwb3J0ZWRdWyN3aWtpLXVuc3VwcG9ydGVkXTogZGlzcGxheXMgYSBub3RpZmljYXRpb24gaWYgdGhlIGJvb2ttYXJrbGV0IGlzIHJ1biBvbiBhblxuICAgdW5zdXBwb3J0ZWQgYnJvd3NlclxuXG5hbmQgb3B0aW9uYWxseSwgdGhlIFtUYWdzIHBsdWdpbl1bI3dpa2ktdGFnc10uXG5cbkNvbmZpZ3VyYXRpb25cbi0tLS0tLS0tLS0tLS1cblxuSW4gb3JkZXIgdG8gY29uZmlndXJlIHRoZSBib29rbWFya2xldCBmb3IgeW91ciBuZWVkcyBpdCBhY2NlcHRzIGBjb25maWdgIGhhc2ggb2Zcbm9wdGlvbnMuIFRoZXNlIGFyZSBzZXQgaW4gdGhlIF9jb25maWcuanNvbl8gZmlsZS4gVGhlcmUncyBhbiBleGFtcGxlIGluIHRoZVxucmVwb3NpdG9yeSAoc2VlIF9jb25maWcuZXhhbXBsZS5qc29uXykuIFRoZSBvcHRpb25zIGFyZSBhcyBmb2xsb3dzOlxuXG4jIyMgZXh0ZXJuYWxzXG5cbiAtIGBzb3VyY2VgOiBUaGUgZ2VuZXJhdGVkIEFubm90YXRvciBKYXZhc2NyaXB0IHNvdXJjZSBjb2RlIChzZWUgRGV2ZWxvcG1lbnQpXG4gLSBgc3R5bGVzYDogVGhlIGdlbmVyYXRlZCBBbm5vdGF0b3IgQ1NTIHNvdXJjZSBjb2RlIChzZWUgRGV2ZWxvcG1lbnQpXG5cbiMjIyBhdXRoXG5cblNldHRpbmdzIGZvciB0aGUgW0F1dGggcGx1Z2luXVsjd2lraS1hdXRoXVxuXG4tIGB0b2tlblVybGA6IFRoZSBVUkwgb2YgdGhlIGF1dGggdG9rZW4gZ2VuZXJhdG9yIHRvIHVzZSAoZGVmYXVsdDogaHR0cDovL2Fubm90YXRlaXQub3JnL2FwaS90b2tlbilcblxuIyMjIHN0b3JlXG5cblNldHRpbmdzIGZvciB0aGUgW1N0b3JlIHBsdWdpbl1bI3dpa2ktc3RvcmVdLlxuXG4gLSBgcHJlZml4YDogVGhlIHByZWZpeCBVUkwgZm9yIHRoZSBzdG9yZSAoZGVmYXVsdDogaHR0cDovL2Fubm90YXRlaXQub3JnL2FwaSlcblxuIyMjIHBlcm1pc3Npb25zXG5cblNldHRpbmdzIGZvciB0aGUgW1Blcm1pc3Npb25zIHBsdWdpbl1bI3dpa2ktcGVybWlzc2lvbnNdLlxuXG4jIyMjIHRhZ3NcblxuSWYgdGhpcyBpcyBzZXQgdG8gYHRydWVgIHRoZSBbVGFncyBwbHVnaW5dWyN3aWtpLXRhZ3NdIHdpbGwgYmUgbG9hZGVkLlxuKi9cbihmdW5jdGlvbiAob3B0aW9ucywgd2luZG93LCBkb2N1bWVudCkge1xuICBcInVzZSBzdHJpY3RcIjtcblxuICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHksXG4gICAgICBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXSxcbiAgICAgIGdsb2JhbHMgPSBbJ0Fubm90YXRvciddLFxuICAgICAgaXNMb2FkZWQgPSB7fSxcbiAgICAgIGJvb2ttYXJrbGV0ID0ge30sXG4gICAgICBub3RpZmljYXRpb24sIG5hbWVzcGFjZTtcblxuICB3aGlsZSAoZ2xvYmFscy5sZW5ndGgpIHtcbiAgICBuYW1lc3BhY2UgPSBnbG9iYWxzLnNoaWZ0KCk7XG4gICAgaXNMb2FkZWRbbmFtZXNwYWNlXSA9IHdpbmRvdy5oYXNPd25Qcm9wZXJ0eShuYW1lc3BhY2UpO1xuICB9XG5cbiAgbm90aWZpY2F0aW9uID0gKGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxuICAgICAgICB0cmFuc2l0aW9uID0gJ3RvcCAwLjRzIGVhc2Utb3V0JyxcbiAgICAgICAgc3R5bGVzICA9IHtcbiAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snLFxuICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuICAgICAgICAgIGZvbnRGYW1pbHk6ICdcIkhlbHZldGljYSBOZXVlXCIsIEFyaWFsLCBIZWx2ZXRpY2EsIHNhbnMtc2VyaWYnLFxuICAgICAgICAgIGZvbnRTaXplOiAnMTRweCcsXG4gICAgICAgICAgY29sb3I6ICcjZmZmJyxcbiAgICAgICAgICB0b3A6ICctNTRweCcsXG4gICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICB3aWR0aDogJzEwMCUnLFxuICAgICAgICAgIHpJbmRleDogOTk5OSxcbiAgICAgICAgICBsaW5lSGVpZ2h0OiAnNTBweCcsXG4gICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjMDAwJyxcbiAgICAgICAgICBib3JkZXJCb3R0b206ICc0cHggc29saWQnLFxuICAgICAgICAgIFdlYmtpdFRyYW5zaXRpb246IHRyYW5zaXRpb24sXG4gICAgICAgICAgTW96VHJhbnNpdGlvbjogdHJhbnNpdGlvbixcbiAgICAgICAgICBPVHJhbnNpdGlvbjogdHJhbnNpdGlvbixcbiAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uXG4gICAgICAgIH0sIHByb3BlcnR5O1xuXG4gICAgZWxlbWVudC5jbGFzc05hbWUgPSAnYW5ub3RhdG9yLWJtLXN0YXR1cyc7XG4gICAgZm9yIChwcm9wZXJ0eSBpbiBzdHlsZXMpIHtcbiAgICAgIGlmIChzdHlsZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKSB7XG4gICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcGVydHldID0gc3R5bGVzW3Byb3BlcnR5XTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBcHBseSBuZXdlciBzdHlsZXMgZm9yIG1vZGVybiBicm93c2Vycy5cbiAgICBlbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJztcbiAgICBlbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICdyZ2JhKDAsIDAsIDAsIDAuOSknO1xuICAgIGVsZW1lbnQub25jbGljayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1czoge1xuICAgICAgICBJTkZPOiAgICAnI2Q0ZDRkNCcsXG4gICAgICAgIFNVQ0NFU1M6ICcjMzY2NWY5JyxcbiAgICAgICAgRVJST1I6ICAgJyNmZjdlMDAnXG4gICAgICB9LFxuICAgICAgZWxlbWVudDogZWxlbWVudCxcbiAgICAgIHNob3c6IGZ1bmN0aW9uIChtZXNzYWdlLCBzdGF0dXMpIHtcbiAgICAgICAgdGhpcy5tZXNzYWdlKG1lc3NhZ2UsIHN0YXR1cyk7XG5cbiAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnO1xuICAgICAgICBlbGVtZW50LnN0eWxlLnRvcCA9ICcwJztcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH0sXG4gICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGVsZW1lbnQuc3R5bGUudG9wID0gJy01NHB4JztcblxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XG4gICAgICAgIH0sIDQwMCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9LFxuICAgICAgbWVzc2FnZTogZnVuY3Rpb24gKG1lc3NhZ2UsIHN0YXR1cykge1xuICAgICAgICBzdGF0dXMgPSBzdGF0dXMgfHwgdGhpcy5zdGF0dXMuSU5GTztcblxuICAgICAgICBlbGVtZW50LnN0eWxlLmJvcmRlckNvbG9yID0gc3RhdHVzO1xuICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IG1lc3NhZ2U7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9LFxuICAgICAgZXJyb3I6IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICAgIHRoaXMubWVzc2FnZShtZXNzYWdlLCB0aGlzLnN0YXR1cy5FUlJPUik7XG4gICAgICAgIHNldFRpbWVvdXQodGhpcy5oaWRlLCA1MDAwKTtcbiAgICAgICAgc2V0VGltZW91dCh0aGlzLnJlbW92ZSwgNTUwMCk7XG4gICAgICB9LFxuICAgICAgYXBwZW5kOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfSxcbiAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlO1xuICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuICAgIH0uYXBwZW5kKCk7XG4gIH0oKSk7XG5cbiAgYm9va21hcmtsZXQgPSB7XG4gICAgbm90aWZpY2F0aW9uOiBub3RpZmljYXRpb24sXG5cbiAgICBrZXlwYXRoOiBmdW5jdGlvbiAob2JqZWN0LCBwYXRoLCBmYWxsYmFjaykge1xuICAgICAgdmFyIGtleXMgPSAocGF0aCB8fCAnJykuc3BsaXQoJy4nKSxcbiAgICAgICAgICBrZXk7XG5cbiAgICAgIHdoaWxlIChvYmplY3QgJiYga2V5cy5sZW5ndGgpIHtcbiAgICAgICAga2V5ID0ga2V5cy5zaGlmdCgpO1xuXG4gICAgICAgIGlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtrZXldO1xuXG4gICAgICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwICYmIG9iamVjdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gb2JqZWN0O1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gKGZhbGxiYWNrID09PSBudWxsKSA/IG51bGwgOiBmYWxsYmFjaztcbiAgICB9LFxuXG4gICAgY29uZmlnOiBmdW5jdGlvbiAocGF0aCwgZmFsbGJhY2spIHtcbiAgICAgIHZhciB2YWx1ZSA9IHRoaXMua2V5cGF0aChvcHRpb25zLCBwYXRoLCBmYWxsYmFjayk7XG5cbiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICBub3RpZmljYXRpb24uZXJyb3IoJ1NvcnJ5LCB0aGVyZSB3YXMgYW4gZXJyb3IgcmVhZGluZyB0aGUgYm9va21hcmtsZXQgc2V0dGluZyBmb3Iga2V5OiAnICsgcGF0aCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuXG4gICAgX2luamVjdEVsZW1lbnQ6IGZ1bmN0aW9uICh3aGVyZSwgZWwpIHtcbiAgICAgIGlmICh3aGVyZSA9PSAnaGVhZCcpIHtcbiAgICAgICAgaGVhZC5hcHBlbmRDaGlsZChlbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBib2R5LmFwcGVuZENoaWxkKGVsKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgbG9hZDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgICB2YXIgYW5ub3RhdG9yU291cmNlID0gdGhpcy5jb25maWcoJ2V4dGVybmFscy5zb3VyY2UnLCAnaHR0cDovL2Fzc2V0cy5hbm5vdGF0ZWl0Lm9yZy9ib29rbWFya2xldC9hbm5vdGF0b3ItYm9va21hcmtsZXQubWluLmpzJyksXG4gICAgICAgICAgYW5ub3RhdG9yU3R5bGVzID0gdGhpcy5jb25maWcoJ2V4dGVybmFscy5zdHlsZXMnLCAnaHR0cDovL2Fzc2V0cy5hbm5vdGF0ZWl0Lm9yZy9ib29rbWFya2xldC9hbm5vdGF0b3IubWluLmNzcycpO1xuXG4gICAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTtcbiAgICAgIGxpbmsucmVsID0gJ3N0eWxlc2hlZXQnO1xuICAgICAgbGluay5ocmVmID0gYW5ub3RhdG9yU3R5bGVzO1xuXG4gICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnO1xuICAgICAgc2NyaXB0LnNyYyA9IGFubm90YXRvclNvdXJjZTtcbiAgICAgIHNjcmlwdC5fbG9hZGVkID0gZmFsc2U7XG5cbiAgICAgIHZhciBzY3JpcHRMb2FkZWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHNjcmlwdC5fbG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH07XG5cbiAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHRMb2FkZWQ7XG4gICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICggdGhpcy5yZWFkeVN0YXRlICE9PSBcImxvYWRlZFwiICYmICFzY3JpcHQuX2xvYWRlZCApIHJldHVybjtcbiAgICAgICAgc2NyaXB0TG9hZGVkKCk7XG4gICAgICB9O1xuXG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCFzY3JpcHQuX2xvYWRlZCkge1xuICAgICAgICAgIG5vdGlmaWNhdGlvbi5lcnJvcignU29ycnksIHdlXFwncmUgdW5hYmxlIHRvIGxvYWQgQW5ub3RhdG9yIGF0IHRoZSBtb21lbnQuLi4nKTtcbiAgICAgICAgfVxuICAgICAgfSwgMzAwMDApO1xuXG4gICAgICB0aGlzLl9pbmplY3RFbGVtZW50KCdoZWFkJywgbGluayk7XG4gICAgICB0aGlzLl9pbmplY3RFbGVtZW50KCdib2R5Jywgc2NyaXB0KTtcbiAgICB9LFxuXG4gICAgYXV0aE9wdGlvbnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRva2VuVXJsOiB0aGlzLmNvbmZpZygnYXV0aC50b2tlblVybCcsICdodHRwOi8vYW5ub3RhdGVpdC5vcmcvYXBpL3Rva2VuJyksXG4gICAgICAgIGF1dG9GZXRjaDogdGhpcy5jb25maWcoJ2F1dGguYXV0b0ZldGNoJywgdHJ1ZSlcbiAgICAgIH07XG4gICAgfSxcblxuICAgIHN0b3JlT3B0aW9uczogZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIHVyaSA9IGxvY2F0aW9uLmhyZWYuc3BsaXQoLyN8XFw/Lykuc2hpZnQoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByZWZpeDogdGhpcy5jb25maWcoJ3N0b3JlLnByZWZpeCcsICdodHRwOi8vYW5ub3RhdGVpdC5vcmcvYXBpJyksXG4gICAgICAgIGFubm90YXRpb25EYXRhOiB7ICd1cmknOiB1cmkgfSxcbiAgICAgICAgbG9hZEZyb21TZWFyY2g6IHsgJ3VyaSc6IHVyaSB9XG4gICAgICB9O1xuICAgIH0sXG5cbiAgICBhbm5vdGF0ZUl0UGVybWlzc2lvbnNPcHRpb25zOiBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb25maWcoJ2Fubm90YXRlSXRQZXJtaXNzaW9ucycsIHt9KTtcbiAgICB9LFxuXG4gICAgc2V0dXA6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciBhbm5vdGF0b3IgPSBuZXcgd2luZG93LkFubm90YXRvcihvcHRpb25zLnRhcmdldCB8fCBib2R5KSxcbiAgICAgICAgalF1ZXJ5ID0gd2luZG93LkFubm90YXRvci5VdGlsLiQsXG4gICAgICAgIG5hbWVzcGFjZTtcblxuICAgICAgYW5ub3RhdG9yXG4gICAgICAgIC5hZGRQbHVnaW4oJ1Vuc3VwcG9ydGVkJylcbiAgICAgICAgLmFkZFBsdWdpbignQXV0aCcsIHRoaXMuYXV0aE9wdGlvbnMoKSlcbiAgICAgICAgLmFkZFBsdWdpbignU3RvcmUnLCB0aGlzLnN0b3JlT3B0aW9ucygpKVxuICAgICAgICAuYWRkUGx1Z2luKCdBbm5vdGF0ZUl0UGVybWlzc2lvbnMnLCB0aGlzLmFubm90YXRlSXRQZXJtaXNzaW9uc09wdGlvbnMoKSk7XG5cbiAgICAgIGlmICh0aGlzLmNvbmZpZygndGFncycpID09PSB0cnVlKSB7XG4gICAgICAgICAgYW5ub3RhdG9yLmFkZFBsdWdpbignVGFncycpO1xuICAgICAgfVxuXG4gICAgICAvLyBBdHRhY2ggdGhlIGFubm90YXRvciB0byB0aGUgd2luZG93IG9iamVjdCBzbyB3ZSBjYW4gcHJldmVudCBpdFxuICAgICAgLy8gYmVpbmcgbG9hZGVkIHR3aWNlIGFuZCB0ZXN0LlxuICAgICAgalF1ZXJ5LmV4dGVuZCh3aW5kb3cuX2Fubm90YXRvciwge1xuICAgICAgICBqUXVlcnk6IGpRdWVyeSxcbiAgICAgICAgZWxlbWVudDogYm9keSxcbiAgICAgICAgaW5zdGFuY2U6IGFubm90YXRvcixcbiAgICAgICAgQW5ub3RhdG9yOiB3aW5kb3cuQW5ub3RhdG9yLm5vQ29uZmxpY3QoKVxuICAgICAgfSk7XG5cbiAgICAgIC8vIENsZWFuIHVwIGFmdGVyIG91cnNlbHZlcyBieSByZW1vdmluZyBhbnkgcHJvcGVydGllcyBvbiB3aW5kb3cgdGhhdFxuICAgICAgLy8gd2VyZSBub3QgdGhlcmUgYmVmb3JlLlxuICAgICAgZm9yIChuYW1lc3BhY2UgaW4gaXNMb2FkZWQpIHtcbiAgICAgICAgaWYgKGlzTG9hZGVkLmhhc093blByb3BlcnR5KG5hbWVzcGFjZSkgJiYgIWlzTG9hZGVkW25hbWVzcGFjZV0pIHtcbiAgICAgICAgICBkZWxldGUgd2luZG93W25hbWVzcGFjZV07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbm90aWZpY2F0aW9uLm1lc3NhZ2UoJ0Fubm90YXRvciBpcyByZWFkeSEnLCBub3RpZmljYXRpb24uc3RhdHVzLlNVQ0NFU1MpO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIG5vdGlmaWNhdGlvbi5oaWRlKCk7XG4gICAgICAgIHNldFRpbWVvdXQobm90aWZpY2F0aW9uLnJlbW92ZSwgODAwKTtcbiAgICAgIH0sIDMwMDApO1xuICAgIH0sXG5cbiAgICBpbml0OiBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAod2luZG93Ll9hbm5vdGF0b3IuaW5zdGFuY2UpIHtcbiAgICAgICAgd2luZG93Ll9hbm5vdGF0b3IuQW5ub3RhdG9yLnNob3dOb3RpZmljYXRpb24oXG4gICAgICAgICAgJ0Fubm90YXRvciBpcyBhbHJlYWR5IGxvYWRlZC4gVHJ5IGhpZ2hsaWdodGluZyBzb21lIHRleHQgdG8gZ2V0IHN0YXJ0ZWQuJ1xuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm90aWZpY2F0aW9uLnNob3coJ0xvYWRpbmcgQW5ub3RhdG9yIGludG8gcGFnZScpO1xuICAgICAgICBib29rbWFya2xldC5sb2FkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBib29rbWFya2xldC5zZXR1cCgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgLy8gRXhwb3J0IHRoZSBib29rbWFya2xldCB0byB0aGUgd2luZG93IG9iamVjdCBmb3IgdGVzdGluZy5cbiAgaWYgKCF3aW5kb3cuX2Fubm90YXRvcikge1xuICAgIHdpbmRvdy5fYW5ub3RhdG9yID0ge1xuICAgICAgYm9va21hcmtsZXQ6IGJvb2ttYXJrbGV0XG4gICAgfTtcbiAgfVxuXG4gIC8vIExvYWQgdGhlIGJvb2ttYXJrbGV0LlxuICBpZiAoIW9wdGlvbnMudGVzdCkge1xuICAgIGJvb2ttYXJrbGV0LmluaXQoKTtcbiAgfVxufSh3aW5kb3cuX2Fubm90YXRvckNvbmZpZywgd2luZG93LCB3aW5kb3cuZG9jdW1lbnQpKTtcbiJdfQ==