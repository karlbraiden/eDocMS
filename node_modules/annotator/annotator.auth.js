/*
** Annotator v2.0.0-dev-41928d6
** https://github.com/okfn/annotator/
**
** Copyright 2014, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2014-04-11 02:53:33Z
*/
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self);var o=n;o=o.Annotator||(o.Annotator={}),o=o.Plugin||(o.Plugin={}),o.Auth=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"4hR4NO":[function(_dereq_,module,exports){
(function (global){
var Annotator, self, _ref;

if (typeof self !== "undefined" && self !== null) {
  self = self;
}

if (typeof global !== "undefined" && global !== null) {
  if (self == null) {
    self = global;
  }
}

if (typeof window !== "undefined" && window !== null) {
  if (self == null) {
    self = window;
  }
}

Annotator = self != null ? self.Annotator : void 0;

if (Annotator == null) {
  Annotator = (self != null ? (_ref = self.define) != null ? _ref.amd : void 0 : void 0) ? self != null ? self.require('annotator') : void 0 : void 0;
}

if (typeof Annotator !== 'function') {
  throw new Error("Could not find Annotator! In a webpage context, please ensure that the Annotator script tag is loaded before any plugins.");
}

module.exports = Annotator;


}).call(this,typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],"annotator":[function(_dereq_,module,exports){
module.exports=_dereq_('4hR4NO');
},{}],3:[function(_dereq_,module,exports){
var $, Annotator, Auth, base64Decode, base64UrlDecode, createDateFromISO8601, parseToken,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Annotator = _dereq_('annotator');

$ = Annotator.Util.$;

createDateFromISO8601 = function(string) {
  var d, date, factor, offset, regexp, time;
  regexp = "([0-9]{4})(-([0-9]{2})(-([0-9]{2})" + "(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?" + "(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";
  d = string.match(new RegExp(regexp));
  offset = 0;
  date = new Date(d[1], 0, 1);
  if (d[3]) {
    date.setMonth(d[3] - 1);
  }
  if (d[5]) {
    date.setDate(d[5]);
  }
  if (d[7]) {
    date.setHours(d[7]);
  }
  if (d[8]) {
    date.setMinutes(d[8]);
  }
  if (d[10]) {
    date.setSeconds(d[10]);
  }
  if (d[12]) {
    date.setMilliseconds(Number("0." + d[12]) * 1000);
  }
  if (d[14]) {
    offset = (Number(d[16]) * 60) + Number(d[17]);
    if (d[15] === '-') {
      factor = 1;
    } else {
      factor = -1;
    }
    offset *= factor;
  }
  offset -= date.getTimezoneOffset();
  time = Number(date) + (offset * 60 * 1000);
  date.setTime(Number(time));
  return date;
};

base64Decode = function(data) {
  var ac, b64, bits, dec, h1, h2, h3, h4, i, o1, o2, o3, tmp_arr;
  if (typeof atob !== "undefined" && atob !== null) {
    return atob(data);
  } else {
    b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    i = 0;
    ac = 0;
    dec = "";
    tmp_arr = [];
    if (!data) {
      return data;
    }
    data += '';
    while (i < data.length) {
      h1 = b64.indexOf(data.charAt(i));
      i += 1;
      h2 = b64.indexOf(data.charAt(i));
      i += 1;
      h3 = b64.indexOf(data.charAt(i));
      i += 1;
      h4 = b64.indexOf(data.charAt(i));
      i += 1;
      bits = h1 << 18 | h2 << 12 | h3 << 6 | h4;
      o1 = bits >> 16 & 0xff;
      o2 = bits >> 8 & 0xff;
      o3 = bits & 0xff;
      if (h3 === 64) {
        tmp_arr[ac] = String.fromCharCode(o1);
        ac += 1;
      } else if (h4 === 64) {
        tmp_arr[ac] = String.fromCharCode(o1, o2);
        ac += 1;
      } else {
        tmp_arr[ac] = String.fromCharCode(o1, o2, o3);
        ac += 1;
      }
    }
    return tmp_arr.join('');
  }
};

base64UrlDecode = function(data) {
  var i, m, _i, _ref;
  m = data.length % 4;
  if (m !== 0) {
    for (i = _i = 0, _ref = 4 - m; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      data += '=';
    }
  }
  data = data.replace(/-/g, '+');
  data = data.replace(/_/g, '/');
  return base64Decode(data);
};

parseToken = function(token) {
  var head, payload, sig, _ref;
  _ref = token.split('.'), head = _ref[0], payload = _ref[1], sig = _ref[2];
  return JSON.parse(base64UrlDecode(payload));
};

Auth = (function(_super) {
  __extends(Auth, _super);

  Auth.prototype.options = {
    token: null,
    tokenUrl: '/auth/token',
    autoFetch: true
  };

  function Auth(element, options) {
    Auth.__super__.constructor.apply(this, arguments);
    this.waitingForToken = [];
  }

  Auth.prototype.pluginInit = function() {
    if (this.options.token) {
      return this.setToken(this.options.token);
    } else {
      return this.requestToken();
    }
  };

  Auth.prototype.requestToken = function() {
    this.requestInProgress = true;
    return $.ajax({
      url: this.options.tokenUrl,
      dataType: 'text',
      xhrFields: {
        withCredentials: true
      }
    }).done((function(_this) {
      return function(data, status, xhr) {
        return _this.setToken(data);
      };
    })(this)).fail(function(xhr, status, err) {
      var msg;
      msg = Annotator._t("Couldn't get auth token:");
      console.error("" + msg + " " + err, xhr);
      return Annotator.showNotification("" + msg + " " + xhr.responseText, Annotator.Notification.ERROR);
    }).always((function(_this) {
      return function() {
        return _this.requestInProgress = false;
      };
    })(this));
  };

  Auth.prototype.setToken = function(token) {
    var _results;
    this.token = token;
    this._unsafeToken = parseToken(token);
    if (this.haveValidToken()) {
      if (this.options.autoFetch) {
        this.refreshTimeout = setTimeout(((function(_this) {
          return function() {
            return _this.requestToken();
          };
        })(this)), (this.timeToExpiry() - 2) * 1000);
      }
      this.updateHeaders();
      _results = [];
      while (this.waitingForToken.length > 0) {
        _results.push(this.waitingForToken.pop()(this._unsafeToken));
      }
      return _results;
    } else {
      console.warn(Annotator._t("Didn't get a valid token."));
      if (this.options.autoFetch) {
        console.warn(Annotator._t("Getting a new token in 10s."));
        return setTimeout(((function(_this) {
          return function() {
            return _this.requestToken();
          };
        })(this)), 10 * 1000);
      }
    }
  };

  Auth.prototype.haveValidToken = function() {
    var allFields;
    allFields = this._unsafeToken && this._unsafeToken.issuedAt && this._unsafeToken.ttl && this._unsafeToken.consumerKey;
    if (allFields && this.timeToExpiry() > 0) {
      return true;
    } else {
      return false;
    }
  };

  Auth.prototype.timeToExpiry = function() {
    var expiry, issue, now, timeToExpiry;
    now = new Date().getTime() / 1000;
    issue = createDateFromISO8601(this._unsafeToken.issuedAt).getTime() / 1000;
    expiry = issue + this._unsafeToken.ttl;
    timeToExpiry = expiry - now;
    if (timeToExpiry > 0) {
      return timeToExpiry;
    } else {
      return 0;
    }
  };

  Auth.prototype.updateHeaders = function() {
    var _ref;
    if (((_ref = this.annotator.store) != null ? _ref.setHeader : void 0) != null) {
      return this.annotator.store.setHeader('x-annotator-auth-token', this.token);
    }
  };

  Auth.prototype.withToken = function(callback) {
    if (callback == null) {
      return;
    }
    if (this.haveValidToken()) {
      return callback(this._unsafeToken);
    } else {
      this.waitingForToken.push(callback);
      if (!this.requestInProgress) {
        return this.requestToken();
      }
    }
  };

  return Auth;

})(Annotator.Plugin);

Annotator.Plugin.register('Auth', Auth);

module.exports = Auth;


},{}]},{},[3])

(3)
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGtnL2Fubm90YXRvci5hdXRoLmpzIiwic291cmNlcyI6WyIuLi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvYnJvd3Nlci1wYWNrL19wcmVsdWRlLmpzIiwibmFtZXNwYWNlLmNvZmZlZSIsInBsdWdpbi9hdXRoLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7QUNLQTs7O1NBQU8sSUFBUDs7O0FBQ0E7O1dBQVE7R0FBUjtDQURBOztBQUVBOztXQUFRO0dBQVI7Q0FGQTs7Ozs7RUFNQSxzQkFBYTtDQU5iOztBQVVBO0FBQ0UsUUFBVSxVQUFNLG9CQURsQjtDQVZBOzs7Ozs7Ozs7O0FDTEE7Ozs7WUFBWSxRQUFRLFdBQVIsQ0FBWjs7Q0FDQSxHQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FEbkI7O3FCQVNBLEdBQXdCLFNBQUMsTUFBRDtBQUN0QjtXQUNFLHVDQUNBLHFEQURBLEdBRUEsMENBSEY7RUFNQSxJQUFJLE1BQU0sQ0FBQyxLQUFQLENBQWlCLFdBQU8sTUFBUCxDQUFqQixDQU5KO0VBUUEsU0FBUyxDQVJUO0VBU0EsT0FBVyxTQUFLLENBQUUsR0FBUCxFQUFXLENBQVgsRUFBYyxDQUFkLENBVFg7QUFXQSxNQUEyQixDQUFFLEdBQTdCO1FBQUksQ0FBQyxRQUFMLENBQWMsQ0FBRSxHQUFGLEdBQU8sQ0FBckI7R0FYQTtBQVlBLE1BQXNCLENBQUUsR0FBeEI7UUFBSSxDQUFDLE9BQUwsQ0FBYSxDQUFFLEdBQWY7R0FaQTtBQWFBLE1BQXVCLENBQUUsR0FBekI7UUFBSSxDQUFDLFFBQUwsQ0FBYyxDQUFFLEdBQWhCO0dBYkE7QUFjQSxNQUF5QixDQUFFLEdBQTNCO1FBQUksQ0FBQyxVQUFMLENBQWdCLENBQUUsR0FBbEI7R0FkQTtBQWVBLE1BQTBCLENBQUUsSUFBNUI7UUFBSSxDQUFDLFVBQUwsQ0FBZ0IsQ0FBRSxJQUFsQjtHQWZBO0FBZ0JBLE1BQXFELENBQUUsSUFBdkQ7UUFBSSxDQUFDLGVB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QUFDLGFBQVksQ0FBQyxRQUFwQyxDQUE2QyxDQUFDLE9BQTlDLEtBQTBELElBRGxFO0lBR0EsU0FBUyxRQUFRLElBQUMsYUFBWSxDQUFDLEdBSC9CO0lBSUEsZUFBZSxTQUFTLEdBSnhCO0FBTUEsUUFBSSxlQUFlLENBQW5CO2FBQTJCLGFBQTNCOzthQUE2QyxFQUE3QztLQVBZO0dBcklkOztpQkFpSkEsZ0JBQWU7QUFDYjtRQUFHLHlFQUFIO2FBQ0UsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBckIsQ0FBK0Isd0JBQS9CLEVBQXlELElBQUMsTUFBMUQsRUFERjtLQURhO0dBakpmOztpQkFnS0EsWUFBVyxTQUFDLFFBQUQ7QUFDVCxRQUFPLGdCQUFQO0FBQ0UsYUFERjs7QUFHQSxRQUFHLElBQUksQ0FBQyxjQUFMLEVBQUg7YUFDRSxTQUFTLElBQUMsYUFBVixFQURGOztBQUdFLFVBQUksQ0FBQyxlQUFlLENBQUMsSUFBckIsQ0FBMEIsUUFBMUI7QUFDQSxVQUFHLEtBQUssa0JBQVI7ZUFDRSxJQUFJLENBQUMsWUFBTCxHQURGO09BSkY7S0FKUztHQWhLWDs7OztHQUZpQixTQUFTLENBQUMsT0F2RzdCOztTQW9SUyxDQUFDLE1BQU0sQ0FBQyxRQUFqQixDQUEwQixNQUExQixFQUFrQyxJQUFsQyxDQXBSQTs7TUFzUk0sQ0FBQyxPQUFQLEdBQWlCLElBdFJqQiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKX12YXIgZj1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwoZi5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxmLGYuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiIyBJbiBvcmRlciB0byBidWlsZCBwb3J0YWJsZSBleHRlbnNpb24gYnVuZGxlcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggQU1EIGFuZFxuIyBzY3JpcHQgY29uY2F0ZW5hdGlvbiBwbHVnaW5zIGFyZSBidWlsdCB3aXRoIHRoaXMgbW9kdWxlIGFzICdhbm5vdGF0b3InLlxuXG4jIEFubm90YXRvciB3aWxsIGV4cG9ydCBpdHNlbGYgZ2xvYmFsbHkgd2hlbiB0aGUgYnVpbHQgVU1EIG1vZHVsZXMgYXJlIHVzZWQgaW5cbiMgYSBsZWdhY3kgZW52aXJvbm1lbnQgb2Ygc2ltcGxlIHNjcmlwdCBjb25jYXRlbmF0aW9uLlxuc2VsZiA9IHNlbGYgaWYgc2VsZj9cbnNlbGYgPz0gZ2xvYmFsIGlmIGdsb2JhbD9cbnNlbGYgPz0gd2luZG93IGlmIHdpbmRvdz9cbkFubm90YXRvciA9IHNlbGY/LkFubm90YXRvclxuXG4jIEluIGEgcHVyZSBBTUQgZW52aXJvbm1lbnQsIEFubm90YXRvciBtYXkgbm90IGJlIGV4cG9ydGVkIGdsb2JhbGx5LlxuQW5ub3RhdG9yID89IGlmIHNlbGY/LmRlZmluZT8uYW1kIHRoZW4gc2VsZj8ucmVxdWlyZSgnYW5ub3RhdG9yJylcblxuIyBJZiB3ZSBoYXZlbid0IHN1Y2Nlc3NmdWxseSBsb2FkZWQgQW5ub3RhdG9yIGJ5IHRoaXMgcG9pbnQsIHRoZXJlJ3Mgbm8gcG9pbnQgaW5cbiMgZ29pbmcgb24gdG8gbG9hZCB0aGUgcGx1Z2luLCBzbyB0aHJvdyBhIGZhdGFsIGVycm9yLlxuaWYgdHlwZW9mIEFubm90YXRvciBpc250ICdmdW5jdGlvbidcbiAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGQgbm90IGZpbmQgQW5ub3RhdG9yISBJbiBhIHdlYnBhZ2UgY29udGV4dCwgcGxlYXNlIGVuc3VyZVxuICAgICAgICAgICAgICAgICAgIHRoYXQgdGhlIEFubm90YXRvciBzY3JpcHQgdGFnIGlzIGxvYWRlZCBiZWZvcmUgYW55IHBsdWdpbnMuXCIpXG5cbiMgTm90ZTogd2hlbiB3b3JraW5nIGluIGEgQ29tbW9uSlMgZW52aXJvbm1lbnQgYW5kIGJ1bmRsaW5nIHJlcXVpcmVtZW50cyBpbnRvXG4jIGFwcGxpY2F0aW9ucyB0aGVuIHJlcXVpcmUgY2FsbHMgc2hvdWxkIHJlZmVyIHRvIG1vZHVsZXMgZnJvbSB0aGUgbnBtIGxpYlxuIyBkaXJlY3Rvcnkgb2YgYW5ub3RhdG9yIHBhY2thZ2UgYW5kIGF2b2lkIHRoaXMgYWx0b2dldGhlci5cbm1vZHVsZS5leHBvcnRzID0gQW5ub3RhdG9yXG4iLCJBbm5vdGF0b3IgPSByZXF1aXJlKCdhbm5vdGF0b3InKVxuJCA9IEFubm90YXRvci5VdGlsLiRcblxuXG4jIFB1YmxpYzogQ3JlYXRlcyBhIERhdGUgb2JqZWN0IGZyb20gYW4gSVNPODYwMSBmb3JtYXR0ZWQgZGF0ZSBTdHJpbmcuXG4jXG4jIHN0cmluZyAtIElTTzg2MDEgZm9ybWF0dGVkIGRhdGUgU3RyaW5nLlxuI1xuIyBSZXR1cm5zIERhdGUgaW5zdGFuY2UuXG5jcmVhdGVEYXRlRnJvbUlTTzg2MDEgPSAoc3RyaW5nKSAtPlxuICByZWdleHAgPSAoXG4gICAgXCIoWzAtOV17NH0pKC0oWzAtOV17Mn0pKC0oWzAtOV17Mn0pXCIgK1xuICAgIFwiKFQoWzAtOV17Mn0pOihbMC05XXsyfSkoOihbMC05XXsyfSkoXFxcXC4oWzAtOV0rKSk/KT9cIiArXG4gICAgXCIoWnwoKFstK10pKFswLTldezJ9KTooWzAtOV17Mn0pKSk/KT8pPyk/XCJcbiAgKVxuXG4gIGQgPSBzdHJpbmcubWF0Y2gobmV3IFJlZ0V4cChyZWdleHApKVxuXG4gIG9mZnNldCA9IDBcbiAgZGF0ZSA9IG5ldyBEYXRlKGRbMV0sIDAsIDEpXG5cbiAgZGF0ZS5zZXRNb250aChkWzNdIC0gMSkgaWYgZFszXVxuICBkYXRlLnNldERhdGUoZFs1XSkgaWYgZFs1XVxuICBkYXRlLnNldEhvdXJzKGRbN10pIGlmIGRbN11cbiAgZGF0ZS5zZXRNaW51dGVzKGRbOF0pIGlmIGRbOF1cbiAgZGF0ZS5zZXRTZWNvbmRzKGRbMTBdKSBpZiBkWzEwXVxuICBkYXRlLnNldE1pbGxpc2Vjb25kcyhOdW1iZXIoXCIwLlwiICsgZFsxMl0pICogMTAwMCkgaWYgZFsxMl1cblxuICBpZiBkWzE0XVxuICAgIG9mZnNldCA9IChOdW1iZXIoZFsxNl0pICogNjApICsgTnVtYmVyKGRbMTddKVxuICAgIGlmIGRbMTVdID09ICctJ1xuICAgICAgZmFjdG9yID0gMVxuICAgIGVsc2VcbiAgICAgIGZhY3RvciA9IC0xXG4gICAgb2Zmc2V0ICo9IGZhY3RvclxuXG4gIG9mZnNldCAtPSBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KClcbiAgdGltZSA9IChOdW1iZXIoZGF0ZSkgKyAob2Zmc2V0ICogNjAgKiAxMDAwKSlcblxuICBkYXRlLnNldFRpbWUoTnVtYmVyKHRpbWUpKVxuICBkYXRlXG5cbmJhc2U2NERlY29kZSA9IChkYXRhKSAtPlxuICBpZiBhdG9iP1xuICAgICMgR2Vja28gYW5kIFdlYmtpdCBwcm92aWRlIG5hdGl2ZSBjb2RlIGZvciB0aGlzXG4gICAgYXRvYihkYXRhKVxuICBlbHNlXG4gICAgIyBBZGFwdGVkIGZyb20gTUlUL0JTRCBsaWNlbnNlZCBjb2RlIGF0XG4gICAgIyBodHRwOi8vcGhwanMub3JnL2Z1bmN0aW9ucy9iYXNlNjRfZGVjb2RlIHZlcnNpb24gMTEwOS4yMDE1XG4gICAgYjY0ID0gXCJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvPVwiXG4gICAgaSA9IDBcbiAgICBhYyA9IDBcbiAgICBkZWMgPSBcIlwiXG4gICAgdG1wX2FyciA9IFtdXG5cbiAgICBpZiBub3QgZGF0YVxuICAgICAgcmV0dXJuIGRhdGFcblxuICAgIGRhdGEgKz0gJydcblxuICAgIHdoaWxlIGkgPCBkYXRhLmxlbmd0aFxuICAgICAgIyB1bnBhY2sgZm91ciBoZXhldHMgaW50byB0aHJlZSBvY3RldHMgdXNpbmcgaW5kZXggcG9pbnRzIGluIGI2NFxuICAgICAgaDEgPSBiNjQuaW5kZXhPZihkYXRhLmNoYXJBdChpKSlcbiAgICAgIGkgKz0gMVxuICAgICAgaDIgPSBiNjQuaW5kZXhPZihkYXRhLmNoYXJBdChpKSlcbiAgICAgIGkgKz0gMVxuICAgICAgaDMgPSBiNjQuaW5kZXhPZihkYXRhLmNoYXJBdChpKSlcbiAgICAgIGkgKz0gMVxuICAgICAgaDQgPSBiNjQuaW5kZXhPZihkYXRhLmNoYXJBdChpKSlcbiAgICAgIGkgKz0gMVxuXG4gICAgICBiaXRzID0gaDEgPDwgMTggfCBoMiA8PCAxMiB8IGgzIDw8IDYgfCBoNFxuXG4gICAgICBvMSA9IGJpdHMgPj4gMTYgJiAweGZmXG4gICAgICBvMiA9IGJpdHMgPj4gOCAmIDB4ZmZcbiAgICAgIG8zID0gYml0cyAmIDB4ZmZcblxuICAgICAgaWYgaDMgPT0gNjRcbiAgICAgICAgdG1wX2FyclthY10gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKG8xKVxuICAgICAgICBhYyArPSAxXG4gICAgICBlbHNlIGlmIGg0ID09IDY0XG4gICAgICAgIHRtcF9hcnJbYWNdID0gU3RyaW5nLmZyb21DaGFyQ29kZShvMSwgbzIpXG4gICAgICAgIGFjICs9IDFcbiAgICAgIGVsc2VcbiAgICAgICAgdG1wX2FyclthY10gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKG8xLCBvMiwgbzMpXG4gICAgICAgIGFjICs9IDFcblxuICAgIHRtcF9hcnIuam9pbignJylcblxuYmFzZTY0VXJsRGVjb2RlID0gKGRhdGEpIC0+XG4gIG0gPSBkYXRhLmxlbmd0aCAlIDRcbiAgaWYgbSAhPSAwXG4gICAgZm9yIGkgaW4gWzAuLi40IC0gbV1cbiAgICAgIGRhdGEgKz0gJz0nXG4gIGRhdGEgPSBkYXRhLnJlcGxhY2UoLy0vZywgJysnKVxuICBkYXRhID0gZGF0YS5yZXBsYWNlKC9fL2csICcvJylcbiAgYmFzZTY0RGVjb2RlKGRhdGEpXG5cbnBhcnNlVG9rZW4gPSAodG9rZW4pIC0+XG4gIFtoZWFkLCBwYXlsb2FkLCBzaWddID0gdG9rZW4uc3BsaXQoJy4nKVxuICBKU09OLnBhcnNlKGJhc2U2NFVybERlY29kZShwYXlsb2FkKSlcblxuIyBQdWJsaWM6IFN1cHBvcnRzIHRoZSBTdG9yZSBwbHVnaW4gYnkgcHJvdmlkaW5nIEF1dGhlbnRpY2F0aW9uIGhlYWRlcnMuXG5jbGFzcyBBdXRoIGV4dGVuZHMgQW5ub3RhdG9yLlBsdWdpblxuICAjIFVzZXIgb3B0aW9ucyB0aGF0IGNhbiBiZSBwcm92aWRlZC5cbiAgb3B0aW9uczpcblxuICAgICMgQW4gYXV0aGVudGljYXRpb24gdG9rZW4uIFVzZWQgdG8gc2tpcCB0aGUgcmVxdWVzdCB0byB0aGUgc2VydmVyIGZvciBhXG4gICAgIyBhIHRva2VuLlxuICAgIHRva2VuOiBudWxsXG5cbiAgICAjIFRoZSBVUkwgb24gdGhlIGxvY2FsIHNlcnZlciB0byByZXF1ZXN0IGFuIGF1dGhlbnRpY2F0aW9uIHRva2VuLlxuICAgIHRva2VuVXJsOiAnL2F1dGgvdG9rZW4nXG5cbiAgICAjIElmIHRydWUgd2lsbCB0cnkgYW5kIGZldGNoIGEgdG9rZW4gd2hlbiB0aGUgcGx1Z2luIGlzIGluaXRpYWxpc2VkLlxuICAgIGF1dG9GZXRjaDogdHJ1ZVxuXG4gICMgUHVibGljOiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIEF1dGggcGx1Z2luLlxuICAjXG4gICMgZWxlbWVudCAtIFRoZSBlbGVtZW50IHRvIGJpbmQgYWxsIGV2ZW50cyB0by4gVXN1YWxseSB0aGUgQW5ub3RhdG9yI2VsZW1lbnQuXG4gICMgb3B0aW9ucyAtIEFuIE9iamVjdCBsaXRlcmFsIGNvbnRhaW5pbmcgdXNlciBvcHRpb25zLlxuICAjXG4gICMgRXhhbXBsZXNcbiAgI1xuICAjICAgcGx1Z2luID0gbmV3IEFubm90YXRvci5QbHVnaW4uQXV0aChhbm5vdGF0b3IuZWxlbWVudCwge1xuICAjICAgICB0b2tlblVybDogJy9teS9jdXN0b20vcGF0aCdcbiAgIyAgIH0pXG4gICNcbiAgIyBSZXR1cm5zIGluc3RhbmNlIG9mIEF1dGguXG4gIGNvbnN0cnVjdG9yOiAoZWxlbWVudCwgb3B0aW9ucykgLT5cbiAgICBzdXBlclxuXG4gICAgIyBMaXN0IG9mIGZ1bmN0aW9ucyB0byBiZSBleGVjdXRlZCB3aGVuIHdlIGhhdmUgYSB2YWxpZCB0b2tlbi5cbiAgICBAd2FpdGluZ0ZvclRva2VuID0gW11cblxuICAjIFB1YmxpYzogSW5pdGlhbGlzZXMgdGhlIHBsdWdpbi5cbiAgI1xuICAjIFJldHVybnMgbm90aGluZy5cbiAgcGx1Z2luSW5pdDogLT5cbiAgICBpZiBAb3B0aW9ucy50b2tlblxuICAgICAgdGhpcy5zZXRUb2tlbihAb3B0aW9ucy50b2tlbilcbiAgICBlbHNlXG4gICAgICB0aGlzLnJlcXVlc3RUb2tlbigpXG5cbiAgIyBQdWJsaWM6IE1ha2VzIGEgcmVxdWVzdCB0byB0aGUgbG9jYWwgc2VydmVyIGZvciBhbiBhdXRoZW50aWNhdGlvbiB0b2tlbi5cbiAgI1xuICAjIEV4YW1wbGVzXG4gICNcbiAgIyAgIGF1dGgucmVxdWVzdFRva2VuKClcbiAgI1xuICAjIFJldHVybnMganFYSFIgb2JqZWN0LlxuICByZXF1ZXN0VG9rZW46IC0+XG4gICAgQHJlcXVlc3RJblByb2dyZXNzID0gdHJ1ZVxuXG4gICAgJC5hamF4XG4gICAgICB1cmw6IEBvcHRpb25zLnRva2VuVXJsXG4gICAgICBkYXRhVHlwZTogJ3RleHQnXG4gICAgICB4aHJGaWVsZHM6XG4gICAgICAgIHdpdGhDcmVkZW50aWFsczogdHJ1ZSAjIFNlbmQgYW55IGF1dGggY29va2llcyB0byB0aGUgYmFja2VuZFxuXG4gICAgIyBvbiBzdWNjZXNzLCBzZXQgdGhlIGF1dGggdG9rZW5cbiAgICAuZG9uZSAoZGF0YSwgc3RhdHVzLCB4aHIpID0+XG4gICAgICB0aGlzLnNldFRva2VuKGRhdGEpXG5cbiAgICAjIG9uIGZhaWx1cmUsIHJlbGF5IGFueSBtZXNzYWdlIGdpdmVuIGJ5IHRoZSBzZXJ2ZXIgdG8gdGhlIHVzZXIgd2l0aCBhXG4gICAgIyBub3RpZmljYXRpb25cbiAgICAuZmFpbCAoeGhyLCBzdGF0dXMsIGVycikgLT5cbiAgICAgIG1zZyA9IEFubm90YXRvci5fdChcIkNvdWxkbid0IGdldCBhdXRoIHRva2VuOlwiKVxuICAgICAgY29uc29sZS5lcnJvciBcIiN7bXNnfSAje2Vycn1cIiwgeGhyXG4gICAgICBBbm5vdGF0b3Iuc2hvd05vdGlmaWNhdGlvbihcbiAgICAgICAgXCIje21zZ30gI3t4aHIucmVzcG9uc2VUZXh0fVwiLFxuICAgICAgICBBbm5vdGF0b3IuTm90aWZpY2F0aW9uLkVSUk9SXG4gICAgICApXG5cbiAgICAjIGFsd2F5cyByZXNldCB0aGUgcmVxdWVzdEluUHJvZ3Jlc3MgaW5kaWNhdG9yXG4gICAgLmFsd2F5cyA9PlxuICAgICAgQHJlcXVlc3RJblByb2dyZXNzID0gZmFsc2VcblxuICAjIFB1YmxpYzogU2V0cyB0aGUgQHRva2VuIGFuZCBjaGVja3MgaXQncyB2YWxpZGl0eS4gSWYgdGhlIHRva2VuIGlzIGludmFsaWRcbiAgIyByZXF1ZXN0cyBhIG5ldyBvbmUgZnJvbSB0aGUgc2VydmVyLlxuICAjXG4gICMgdG9rZW4gLSBBIHRva2VuIHN0cmluZy5cbiAgI1xuICAjIEV4YW1wbGVzXG4gICNcbiAgIyAgIGF1dGguc2V0VG9rZW4oJ2V5SmguLi45alEzSScpXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIHNldFRva2VuOiAodG9rZW4pIC0+XG4gICAgQHRva2VuID0gdG9rZW5cbiAgICAjIFBhcnNlIHRoZSB0b2tlbiB3aXRob3V0IHZlcmlmeWluZyBpdHMgYXV0aGVudGljaXR5OlxuICAgIEBfdW5zYWZlVG9rZW4gPSBwYXJzZVRva2VuKHRva2VuKVxuXG4gICAgaWYgdGhpcy5oYXZlVmFsaWRUb2tlbigpXG4gICAgICBpZiBAb3B0aW9ucy5hdXRvRmV0Y2hcbiAgICAgICAgIyBTZXQgdGltZW91dCB0byBmZXRjaCBuZXcgdG9rZW4gMiBzZWNvbmRzIGJlZm9yZSBjdXJyZW50IHRva2VuIGV4cGlyeVxuICAgICAgICBAcmVmcmVzaFRpbWVvdXQgPSBzZXRUaW1lb3V0KFxuICAgICAgICAgICg9PiB0aGlzLnJlcXVlc3RUb2tlbigpKSxcbiAgICAgICAgICAodGhpcy50aW1lVG9FeHBpcnkoKSAtIDIpICogMTAwMFxuICAgICAgICApXG5cbiAgICAgICMgU2V0IGhlYWRlcnMgZmllbGQgb24gdGhpcy5lbGVtZW50XG4gICAgICB0aGlzLnVwZGF0ZUhlYWRlcnMoKVxuXG4gICAgICAjIFJ1biBjYWxsYmFja3Mgd2FpdGluZyBmb3IgdG9rZW5cbiAgICAgIHdoaWxlIEB3YWl0aW5nRm9yVG9rZW4ubGVuZ3RoID4gMFxuICAgICAgICBAd2FpdGluZ0ZvclRva2VuLnBvcCgpKEBfdW5zYWZlVG9rZW4pXG5cbiAgICBlbHNlXG4gICAgICBjb25zb2xlLndhcm4gQW5ub3RhdG9yLl90KFwiRGlkbid0IGdldCBhIHZhbGlkIHRva2VuLlwiKVxuICAgICAgaWYgQG9wdGlvbnMuYXV0b0ZldGNoXG4gICAgICAgIGNvbnNvbGUud2FybiBBbm5vdGF0b3IuX3QoXCJHZXR0aW5nIGEgbmV3IHRva2VuIGluIDEwcy5cIilcbiAgICAgICAgc2V0VGltZW91dCgoPT4gdGhpcy5yZXF1ZXN0VG9rZW4oKSksIDEwICogMTAwMClcblxuICAjIFB1YmxpYzogQ2hlY2tzIHRoZSB2YWxpZGl0eSBvZiB0aGUgY3VycmVudCB0b2tlbi4gTm90ZSB0aGF0IHRoaXMgKmRvZXNcbiAgIyBub3QqIGNoZWNrIHRoZSBhdXRoZW50aWNpdHkgb2YgdGhlIHRva2VuLlxuICAjXG4gICMgRXhhbXBsZXNcbiAgI1xuICAjICAgYXV0aC5oYXZlVmFsaWRUb2tlbigpICMgPT4gUmV0dXJucyB0cnVlIGlmIHZhbGlkLlxuICAjXG4gICMgUmV0dXJucyB0cnVlIGlmIHRoZSB0b2tlbiBpcyB2YWxpZC5cbiAgaGF2ZVZhbGlkVG9rZW46IC0+XG4gICAgYWxsRmllbGRzID0gKFxuICAgICAgQF91bnNhZmVUb2tlbiBhbmRcbiAgICAgIEBfdW5zYWZlVG9rZW4uaXNzdWVkQXQgYW5kXG4gICAgICBAX3Vuc2FmZVRva2VuLnR0bCBhbmRcbiAgICAgIEBfdW5zYWZlVG9rZW4uY29uc3VtZXJLZXlcbiAgICApXG5cbiAgICBpZiBhbGxGaWVsZHMgJiYgdGhpcy50aW1lVG9FeHBpcnkoKSA+IDBcbiAgICAgIHJldHVybiB0cnVlXG4gICAgZWxzZVxuICAgICAgcmV0dXJuIGZhbHNlXG5cbiAgIyBQdWJsaWM6IENhbGN1bGF0ZXMgdGhlIHRpbWUgaW4gc2Vjb25kcyB1bnRpbCB0aGUgY3VycmVudCB0b2tlbiBleHBpcmVzLlxuICAjXG4gICMgUmV0dXJucyBOdW1iZXIgb2Ygc2Vjb25kcyB1bnRpbCB0b2tlbiBleHBpcmVzLlxuICB0aW1lVG9FeHBpcnk6IC0+XG4gICAgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwXG4gICAgaXNzdWUgPSBjcmVhdGVEYXRlRnJvbUlTTzg2MDEoQF91bnNhZmVUb2tlbi5pc3N1ZWRBdCkuZ2V0VGltZSgpIC8gMTAwMFxuXG4gICAgZXhwaXJ5ID0gaXNzdWUgKyBAX3Vuc2FmZVRva2VuLnR0bFxuICAgIHRpbWVUb0V4cGlyeSA9IGV4cGlyeSAtIG5vd1xuXG4gICAgaWYgKHRpbWVUb0V4cGlyeSA+IDApIHRoZW4gdGltZVRvRXhwaXJ5IGVsc2UgMFxuXG4gICMgUHVibGljOiBVcGRhdGVzIHRoZSBoZWFkZXJzIHRvIGJlIHNlbnQgd2l0aCB0aGUgU3RvcmUgcmVxdWVzdHMuXG4gICNcbiAgIyBSZXR1cm5zIG5vdGhpbmcuXG4gIHVwZGF0ZUhlYWRlcnM6IC0+XG4gICAgaWYgdGhpcy5hbm5vdGF0b3Iuc3RvcmU/LnNldEhlYWRlcj9cbiAgICAgIHRoaXMuYW5ub3RhdG9yLnN0b3JlLnNldEhlYWRlcigneC1hbm5vdGF0b3ItYXV0aC10b2tlbicsIEB0b2tlbilcblxuICAjIFJ1bnMgdGhlIHByb3ZpZGVkIGNhbGxiYWNrIGlmIGEgdmFsaWQgdG9rZW4gaXMgYXZhaWxhYmxlLiBPdGhlcndpc2UgcmVxdWVzdHNcbiAgIyBhIHRva2VuIHVudGlsIGl0IHJlY2lldmVzIGEgdmFsaWQgb25lLlxuICAjXG4gICMgY2FsbGJhY2sgLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGNhbGwgb25jZSBhIHZhbGlkIHRva2VuIGlzIG9idGFpbmVkLlxuICAjXG4gICMgRXhhbXBsZXNcbiAgI1xuICAjICAgYXV0aC53aXRoVG9rZW4gLT5cbiAgIyAgICAgc3RvcmUubG9hZEFubm90YXRpb25zKClcbiAgI1xuICAjIFJldHVybnMgbm90aGluZy5cbiAgd2l0aFRva2VuOiAoY2FsbGJhY2spIC0+XG4gICAgaWYgbm90IGNhbGxiYWNrP1xuICAgICAgcmV0dXJuXG5cbiAgICBpZiB0aGlzLmhhdmVWYWxpZFRva2VuKClcbiAgICAgIGNhbGxiYWNrKEBfdW5zYWZlVG9rZW4pXG4gICAgZWxzZVxuICAgICAgdGhpcy53YWl0aW5nRm9yVG9rZW4ucHVzaChjYWxsYmFjaylcbiAgICAgIGlmIG5vdCBAcmVxdWVzdEluUHJvZ3Jlc3NcbiAgICAgICAgdGhpcy5yZXF1ZXN0VG9rZW4oKVxuXG5Bbm5vdGF0b3IuUGx1Z2luLnJlZ2lzdGVyKCdBdXRoJywgQXV0aClcblxubW9kdWxlLmV4cG9ydHMgPSBBdXRoXG4iXX0=