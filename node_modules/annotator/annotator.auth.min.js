/*
** Annotator v2.0.0-dev-41928d6
** https://github.com/okfn/annotator/
**
** Copyright 2014, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2014-04-11 02:53:33Z
*/
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self);var n=t;n=n.Annotator||(n.Annotator={}),n=n.Plugin||(n.Plugin={}),n.Auth=e()}}(function(){return function e(t,n,o){function r(u,s){if(!n[u]){if(!t[u]){var f="function"==typeof require&&require;if(!s&&f)return f(u,!0);if(i)return i(u,!0);throw new Error("Cannot find module '"+u+"'")}var a=n[u]={exports:{}};t[u][0].call(a.exports,function(e){var n=t[u][1][e];return r(n?n:e)},a,a.exports,e,t,n,o)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<o.length;u++)r(o[u]);return r}({"4hR4NO":[function(e,t){(function(e){var n,o,r;if("undefined"!=typeof o&&null!==o&&(o=o),"undefined"!=typeof e&&null!==e&&null==o&&(o=e),"undefined"!=typeof window&&null!==window&&null==o&&(o=window),n=null!=o?o.Annotator:void 0,null==n&&(n=(null!=o?null!=(r=o.define)?r.amd:void 0:void 0)?null!=o?o.require("annotator"):void 0:void 0),"function"!=typeof n)throw new Error("Could not find Annotator! In a webpage context, please ensure that the Annotator script tag is loaded before any plugins.");t.exports=n}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],annotator:[function(e,t){t.exports=e("4hR4NO")},{}],3:[function(e,t){var n,o,r,i,u,s,f,a={}.hasOwnProperty,l=function(e,t){function n(){this.constructor=e}for(var o in t)a.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};o=e("annotator"),n=o.Util.$,s=function(e){var t,n,o,r,i,u;return i="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",t=e.match(new RegExp(i)),r=0,n=new Date(t[1],0,1),t[3]&&n.setMonth(t[3]-1),t[5]&&n.setDate(t[5]),t[7]&&n.setHours(t[7]),t[8]&&n.setMinutes(t[8]),t[10]&&n.setSeconds(t[10]),t[12]&&n.setMilliseconds(1e3*Number("0."+t[12])),t[14]&&(r=60*Number(t[16])+Number(t[17]),o="-"===t[15]?1:-1,r*=o),r-=n.getTimezoneOffset(),u=Number(n)+60*r*1e3,n.setTime(Number(u)),n},i=function(e){var t,n,o,r,i,u,s,f,a,l,d,p,h;if("undefined"!=typeof atob&&null!==atob)return atob(e);if(n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=0,t=0,r="",h=[],!e)return e;for(e+="";a<e.length;)i=n.indexOf(e.charAt(a)),a+=1,u=n.indexOf(e.charAt(a)),a+=1,s=n.indexOf(e.charAt(a)),a+=1,f=n.indexOf(e.charAt(a)),a+=1,o=i<<18|u<<12|s<<6|f,l=o>>16&255,d=o>>8&255,p=255&o,64===s?(h[t]=String.fromCharCode(l),t+=1):64===f?(h[t]=String.fromCharCode(l,d),t+=1):(h[t]=String.fromCharCode(l,d,p),t+=1);return h.join("")},u=function(e){var t,n,o,r;if(n=e.length%4,0!==n)for(t=o=0,r=4-n;r>=0?r>o:o>r;t=r>=0?++o:--o)e+="=";return e=e.replace(/-/g,"+"),e=e.replace(/_/g,"/"),i(e)},f=function(e){var t,n,o,r;return r=e.split("."),t=r[0],n=r[1],o=r[2],JSON.parse(u(n))},r=function(e){function t(){t.__super__.constructor.apply(this,arguments),this.waitingForToken=[]}return l(t,e),t.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},t.prototype.pluginInit=function(){return this.options.token?this.setToken(this.options.token):this.requestToken()},t.prototype.requestToken=function(){return this.requestInProgress=!0,n.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(e){return function(t){return e.setToken(t)}}(this)).fail(function(e,t,n){var r;return r=o._t("Couldn't get auth token:"),console.error(""+r+" "+n,e),o.showNotification(""+r+" "+e.responseText,o.Notification.ERROR)}).always(function(e){return function(){return e.requestInProgress=!1}}(this))},t.prototype.setToken=function(e){var t;if(this.token=e,this._unsafeToken=f(e),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(e){return function(){return e.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),t=[];this.waitingForToken.length>0;)t.push(this.waitingForToken.pop()(this._unsafeToken));return t}return console.warn(o._t("Didn't get a valid token.")),this.options.autoFetch?(console.warn(o._t("Getting a new token in 10s.")),setTimeout(function(e){return function(){return e.requestToken()}}(this),1e4)):void 0},t.prototype.haveValidToken=function(){var e;return e=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,e&&this.timeToExpiry()>0?!0:!1},t.prototype.timeToExpiry=function(){var e,t,n,o;return n=(new Date).getTime()/1e3,t=s(this._unsafeToken.issuedAt).getTime()/1e3,e=t+this._unsafeToken.ttl,o=e-n,o>0?o:0},t.prototype.updateHeaders=function(){var e;return null!=(null!=(e=this.annotator.store)?e.setHeader:void 0)?this.annotator.store.setHeader("x-annotator-auth-token",this.token):void 0},t.prototype.withToken=function(e){return null!=e?this.haveValidToken()?e(this._unsafeToken):(this.waitingForToken.push(e),this.requestInProgress?void 0:this.requestToken()):void 0},t}(o.Plugin),o.Plugin.register("Auth",r),t.exports=r},{}]},{},[3])(3)});
//# sourceMappingURL=annotator.auth.min.js.map